<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gym Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #050510;
            color: #b8b8d0;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 100%;
            min-height: 100vh;
        }

        .header {
            background: #0d0d1a;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #3a2a5a;
            box-shadow: 0 4px 20px rgba(58, 42, 90, 0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 24px;
        }

        .week-indicator {
            font-size: 14px;
            color: #6a5a8a;
            margin-bottom: 15px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: #6a5a8a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        .content {
            padding: 20px;
        }

        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .day-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .section-title {
            font-size: 14px;
            color: #6a5a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }

        .exercise-card {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .exercise-card.logged {
            border-color: #3a2a5a;
            background: #12121f;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 600;
        }

        .previous-data {
            font-size: 12px;
            color: #888;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            display: block;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 16px;
            -webkit-appearance: none;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3a2a5a;
        }

        .input-field:disabled {
            opacity: 0.5;
        }

        .log-btn {
            width: 100%;
            padding: 12px;
            background: #3a2a5a;
            border: none;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .log-btn:active {
            transform: scale(0.98);
        }

        .log-btn.logged {
            background: #1a1a2a;
            color: #6a5a8a;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: #2a1a3a;
            border: none;
            border-radius: 12px;
            color: #b8b8d0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            background: #1a1a2a;
            color: #666;
        }

        .na-btn {
            width: 100%;
            padding: 12px;
            background: #3a1a1a;
            border: 2px solid #6a2a2a;
            border-radius: 8px;
            color: #d08888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .na-btn:hover {
            background: #4a2222;
            border-color: #8a3a3a;
        }

        .na-btn:active {
            transform: scale(0.98);
        }

        .week-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-nav-btn {
            padding: 8px 16px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .week-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .week-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        .history-item {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .history-date {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .history-exercise {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2a;
            font-size: 14px;
        }

        .history-exercise:last-child {
            border-bottom: none;
        }

        .history-exercise-name {
            color: #6a5a8a;
        }

        .history-exercise-data {
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .success-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #3a2a5a;
            color: #b8b8d0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }




        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 5, 16, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid #2a2a3a;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn.primary {
            background: #3a2a5a;
            border-color: #3a2a5a;
            color: #b8b8d0;
        }

        .modal-btn.danger {
            background: #3a1a2a;
            border-color: #3a1a2a;
            color: #b8b8d0;
        }

        .file-input {
            display: none;
        }

        .backup-reminder {
            background: #ff9500;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Week 1 default weights
        const WEEK_1_DEFAULTS = {
            'chest-flies': '165',
            'incline-chest-press': '110',
            'shoulder-press': '126.25',
            'preacher-curls': '56.25',
            'tricep-pushdown': '36.25',
            'lateral-raises': '27.5',
            'overhead-tricep': '27.5',
            'upper-back-row': '190',
            'kelso-shrugs': '190',
            'frontal-pulldowns': '180',
            'hammer-row': '117.5',
            'leg-extensions': '240',
            'leg-curls': '150',
            'hip-adduction': '120',
            'calf-raise': '180',
            'ab-crunch': '140'
        };

        // PR Auto-Regulation: Weight increments when you hit 8+ reps
        // Edit these values to customize weight progression for each exercise
        const PR_WEIGHT_INCREMENTS = {
            'chest-flies': 1.25,
            'incline-chest-press': 1.25,
            'shoulder-press': 1.25,
            'preacher-curls': 1.25,
            'tricep-pushdown': 1.25,
            'lateral-raises': 1.25,
            'overhead-tricep': 1.25,
            'frontal-pulldowns': 1.25,
            'upper-back-row': 1.25,
            'kelso-shrugs': 1.25,
            'hammer-row': 1.25,
            'leg-extensions': 1.25,
            'leg-curls': 5,
            'hip-adduction': 1.25,
            'calf-raise': 1.25,
            'ab-crunch': 1.25,
            'cable-wrist-curls': 1.25,
            'reverse-wrist-curls': 1.25
        };

        // Plate-loaded exercises configuration
        // Defines which exercises show the "Weight Breakdown" button
        // type: 'one-sided' or 'two-sided'
        // machineWeight: starting weight of the machine (usually 0 for plate-loaded)
        const PLATE_LOADED_EXERCISES = {
            'preacher-curls': { type: 'one-sided', machineWeight: 0 },
            'leg-curls': { type: 'two-sided', machineWeight: 0 },
            'hip-adduction': { type: 'one-sided', machineWeight: 0 } 
        };

        // Pin-stack exercises configuration
        // These machines use weight stacks with 5 lb increments
        // Can add micro-plates (1.25, 2.5, or 3.75) on top of the pin
        const PIN_STACK_EXERCISES = {
            'chest-flies': true,
            'incline-chest-press': true,
            'shoulder-press': true,
            'tricep-pushdown': true,
            'lateral-raises': true,
            'overhead-tricep': true,
            'frontal-pulldowns': true,
            'upper-back-row': true,
            'kelso-shrugs': true,
            'hammer-row': true,
            'leg-extensions': true,
            'calf-raise': true,
            'ab-crunch': true,
            'cable-wrist-curls': true,
            'reverse-wrist-curls': true
        };

        const DEFAULT_DAY_1_EXERCISES = [
            // Anterior
            { id: 'chest-flies', name: 'Chest Flies', category: 'Anterior', type: 'standard', order: 0 },
            { id: 'incline-chest-press', name: 'Incline Chest Flies', category: 'Anterior', type: 'standard', order: 1 },
            { id: 'tricep-pushdown', name: 'Cuffed Tricep Pushdown', category: 'Anterior', type: 'standard', order: 2 },
            { id: 'overhead-tricep', name: 'Cuffed Overhead Tricep Extension', category: 'Anterior', type: 'standard', order: 3 },
            { id: 'lateral-raises', name: 'Lateral Raises', category: 'Anterior', type: 'standard', order: 4 },
            { id: 'shoulder-press', name: 'Shoulder Press Machine', category: 'Anterior', type: 'standard', order: 5 },
            { id: 'ab-crunch', name: 'Ab Crunch Machine', category: 'Anterior', type: 'standard', order: 6 },
            { id: 'hip-adduction', name: 'Squats', category: 'Anterior', type: 'standard', order: 7 },
            { id: 'leg-extensions', name: 'Leg Extensions', category: 'Anterior', type: 'standard', order: 8 },
            // Cardio
            // SWAP: Uncomment assault-bike-anterior and comment out stairmaster-anterior to switch back
            // { id: 'assault-bike-anterior', name: 'Assault Bike', category: 'Cardio', type: 'assault-bike', order: 9 },
            { id: 'stairmaster-anterior', name: 'Stairmaster', category: 'Cardio', type: 'stairmaster', order: 9 },
        ];

        const DEFAULT_DAY_2_EXERCISES = [
            // Posterior
            { id: 'preacher-curls', name: 'Preacher Curls', category: 'Posterior', type: 'standard', order: 0 },
            { id: 'frontal-pulldowns', name: 'Frontal Plane Pulldowns', category: 'Posterior', type: 'standard', order: 1 },
            { id: 'upper-back-row', name: 'Upper Back Row Machine', category: 'Posterior', type: 'standard', order: 2 },
            { id: 'kelso-shrugs', name: 'Kelso Shrugs', category: 'Posterior', type: 'standard', order: 3 },
            { id: 'hammer-row', name: 'Seated Row Machine', category: 'Posterior', type: 'standard', order: 4 },
            { id: 'cable-wrist-curls', name: 'Cable Wrist Curls', category: 'Posterior', type: 'standard', order: 5 },
            { id: 'reverse-wrist-curls', name: 'Reverse Wrist Curls', category: 'Posterior', type: 'standard', order: 6 },
            { id: 'leg-curls', name: 'Stiff Legged Deadlifts', category: 'Posterior', type: 'standard', order: 7 },
            { id: 'calf-raise', name: 'Seated Calf Raise Machine', category: 'Posterior', type: 'standard', order: 8 },
            // Cardio
            // SWAP: Uncomment assault-bike and comment out stairmaster to switch back
            // { id: 'assault-bike', name: 'Assault Bike', category: 'Cardio', type: 'assault-bike', order: 9 },
            { id: 'stairmaster', name: 'Stairmaster', category: 'Cardio', type: 'stairmaster', order: 9 },
        ];

        // Get today's date string for localStorage key
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

        // Get the active day for today from localStorage, or default to Anterior (1)
        function getTodayDay() {
            const todayKey = 'activeDay_' + getTodayDateString();
            const savedDay = storage.getItem(todayKey);
            if (savedDay) {
                return parseInt(savedDay);
            }
            return 1; // Default to Anterior
        }

        // Save the active day for today to localStorage
        function saveActiveDay(day) {
            const todayKey = 'activeDay_' + getTodayDateString();
            storage.setItem(todayKey, day.toString());
        }

        // Get the Monday of the week containing a given date
        function getMondayOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day; // If Sunday (0), go back 6 days; otherwise go to Monday
            d.setDate(d.getDate() + diff);
            return d;
        }

        // Get the Monday of the first workout (Week 1 start date)
        // This is cached in localStorage to avoid recalculating
        function getFirstWorkoutMonday(workoutHistory) {
            // Try to get cached value first
            const cached = storage.getItem('firstWorkoutMonday');
            if (cached) {
                return new Date(cached);
            }

            // If no cache and no workout history, use today as default
            if (!workoutHistory || workoutHistory.length === 0) {
                const today = getMondayOfWeek(new Date());
                storage.setItem('firstWorkoutMonday', today.toISOString());
                return today;
            }

            // Find the earliest workout date
            const earliestWorkout = workoutHistory.reduce((earliest, workout) => {
                const workoutDate = new Date(workout.date);
                return !earliest || workoutDate < earliest ? workoutDate : earliest;
            }, null);

            // Get the Monday of that week
            const firstMonday = getMondayOfWeek(earliestWorkout);

            // Cache it for future use
            storage.setItem('firstWorkoutMonday', firstMonday.toISOString());

            return firstMonday;
        }

        // Calculate consecutive week number starting from first workout
        // Week 1 = the week of the first workout, incrementing indefinitely
        function getConsecutiveWeek(date, workoutHistory) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);

            const firstMonday = getFirstWorkoutMonday(workoutHistory);
            const currentMonday = getMondayOfWeek(d);

            // Calculate weeks difference
            const diffTime = currentMonday - firstMonday;
            const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));

            return diffWeeks + 1; // Week 1 is the first week
        }

        // Calculate current week number (consecutive weeks starting from first workout)
        function getCurrentWeek(workoutHistory) {
            return getConsecutiveWeek(new Date(), workoutHistory);
        }

        // Get week number for a specific date
        function getWeekNumber(date, workoutHistory) {
            return getConsecutiveWeek(date, workoutHistory);
        }

        // Parse MM:SS to total seconds
        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1]) || 0;
            return minutes * 60 + seconds;
        }

        // Format seconds to MM:SS
        function formatSecondsToTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Namespace localStorage based on app path to prevent conflicts between gym-tracker and public-gym-app
        const APP_NAMESPACE = (() => {
            const path = window.location.pathname;
            if (path.includes('/gym-tracker/')) return 'gym-tracker:';
            if (path.includes('/public-gym-app/')) return 'public-gym-app:';
            // Fallback for local development or other paths
            return 'gym-local:';
        })();

        // Helper functions for namespaced localStorage
        const storage = {
            getItem: (key) => localStorage.getItem(APP_NAMESPACE + key),
            setItem: (key, value) => localStorage.setItem(APP_NAMESPACE + key, value),
            removeItem: (key) => localStorage.removeItem(APP_NAMESPACE + key),
        };

        // Migrate existing data to namespaced keys (one-time migration for existing users)
        function migrateToNamespacedStorage() {
            const keysToMigrate = ['gymWorkoutHistory', 'gymExerciseConfig', 'lastBackupReminder'];

            keysToMigrate.forEach(key => {
                // Check if data exists in the old location (without namespace)
                const oldData = localStorage.getItem(key);
                // Check if data already exists in the new location (with namespace)
                const newData = storage.getItem(key);

                // Only migrate if old data exists and new location is empty
                if (oldData && !newData) {
                    storage.setItem(key, oldData);
                    // Optionally remove the old data to clean up
                    // Commenting this out to be safe - users can manually clear old data later
                    // localStorage.removeItem(key);
                }
            });
        }

        // Migrate exercise config when exercises are added/removed from defaults
        // This ensures new exercises show up for existing users
        function migrateExerciseConfig() {
            const savedConfig = storage.getItem('gymExerciseConfig');
            if (!savedConfig) return null; // No saved config, will use defaults

            try {
                const config = JSON.parse(savedConfig);
                const savedDay1 = config.day1 || [];
                const savedDay2 = config.day2 || [];

                // Create lookup maps for saved exercises (by ID)
                const savedDay1ById = new Map(savedDay1.map(e => [e.id, e]));
                const savedDay2ById = new Map(savedDay2.map(e => [e.id, e]));

                // Get sets of exercise IDs for comparison
                const savedDay1Ids = new Set(savedDay1.map(e => e.id));
                const savedDay2Ids = new Set(savedDay2.map(e => e.id));
                const defaultDay1Ids = new Set(DEFAULT_DAY_1_EXERCISES.map(e => e.id));
                const defaultDay2Ids = new Set(DEFAULT_DAY_2_EXERCISES.map(e => e.id));

                // Special handling: treat assault-bike as stairmaster for comparison
                // (since we're replacing one with the other)
                let hasAssaultBikeToStairmasterSwap = false;
                if (savedDay2Ids.has('assault-bike') && defaultDay2Ids.has('stairmaster') && !defaultDay2Ids.has('assault-bike')) {
                    savedDay2Ids.delete('assault-bike');
                    savedDay2Ids.add('stairmaster');
                    hasAssaultBikeToStairmasterSwap = true;
                }

                // Special handling: ab-crunch moved from Day 2 to Day 1
                // Preserve custom name if user renamed it
                let hasAbCrunchDaySwap = false;
                if (savedDay2Ids.has('ab-crunch') && defaultDay1Ids.has('ab-crunch') && !defaultDay2Ids.has('ab-crunch')) {
                    // Move ab-crunch from Day 2 lookup to Day 1 lookup (preserving custom name)
                    const savedAbCrunch = savedDay2ById.get('ab-crunch');
                    savedDay1ById.set('ab-crunch', savedAbCrunch);
                    savedDay1Ids.add('ab-crunch');
                    savedDay2Ids.delete('ab-crunch');
                    hasAbCrunchDaySwap = true;
                }

                // Check if exercise IDs match (ignoring order)
                const setsEqual = (a, b) => {
                    if (a.size !== b.size) return false;
                    for (const item of a) {
                        if (!b.has(item)) return false;
                    }
                    return true;
                };

                const day1Match = setsEqual(savedDay1Ids, defaultDay1Ids);
                const day2Match = setsEqual(savedDay2Ids, defaultDay2Ids);

                if (day1Match && day2Match) {
                    return null; // No migration needed
                }

                console.log('[Exercise Config Migration] Changes detected, migrating...');

                // Helper to migrate a single day's exercises
                const migrateDay = (savedById, defaultExercises, dayName) => {
                    const result = [];

                    // Build new list based on default order
                    for (const defaultEx of defaultExercises) {
                        if (savedById.has(defaultEx.id)) {
                            // Exercise exists in saved - preserve custom name
                            const saved = savedById.get(defaultEx.id);
                            result.push({
                                ...defaultEx,  // Use all default properties (order, type, category)
                                name: saved.name  // Preserve custom name if user renamed it
                            });
                        } else {
                            // New exercise from defaults
                            result.push({ ...defaultEx });
                            console.log(`[${dayName}] Added new exercise: ${defaultEx.name}`);
                        }
                    }

                    // Log removed exercises (for transparency)
                    for (const [id, saved] of savedById) {
                        const isInDefaults = defaultExercises.some(d => d.id === id);
                        const isAssaultBikeReplacement = id === 'assault-bike' && hasAssaultBikeToStairmasterSwap;
                        const isAbCrunchDayMove = id === 'ab-crunch' && hasAbCrunchDaySwap;
                        if (!isInDefaults && !isAssaultBikeReplacement && !isAbCrunchDayMove) {
                            console.log(`[${dayName}] Removed exercise: ${saved.name} (id: ${id})`);
                        }
                    }

                    return result;
                };

                // Handle assault-bike -> stairmaster replacement
                if (hasAssaultBikeToStairmasterSwap) {
                    console.log('[Day 2 (Posterior)] Replacing assault-bike with stairmaster');
                    savedDay2ById.delete('assault-bike');
                }

                // Handle ab-crunch cross-day move
                if (hasAbCrunchDaySwap) {
                    console.log('[Migration] Moving ab-crunch from Day 2 (Posterior) to Day 1 (Anterior)');
                    savedDay2ById.delete('ab-crunch');
                }

                // Migrate each day
                const newDay1 = migrateDay(savedDay1ById, DEFAULT_DAY_1_EXERCISES, 'Day 1 (Anterior)');
                const newDay2 = migrateDay(savedDay2ById, DEFAULT_DAY_2_EXERCISES, 'Day 2 (Posterior)');

                // Save the migrated config
                const newConfig = { day1: newDay1, day2: newDay2 };
                storage.setItem('gymExerciseConfig', JSON.stringify(newConfig));

                console.log('[Exercise Config Migration] Complete! Exercise list updated to match defaults.');

                return newConfig;
            } catch (e) {
                console.error('[Exercise Config Migration] Error:', e);
                return null;
            }
        }

        function App() {
            const [currentView, setCurrentView] = useState('workout');
            const [currentDay, setCurrentDay] = useState(getTodayDay());
            const [workoutData, setWorkoutData] = useState({});
            const [loggedExercises, setLoggedExercises] = useState({});
            const [workoutHistory, setWorkoutHistory] = useState([]);
            const [showSuccess, setShowSuccess] = useState(false);
            const [successMessage, setSuccessMessage] = useState('');
            const [day1Exercises, setDay1Exercises] = useState(DEFAULT_DAY_1_EXERCISES);
            const [day2Exercises, setDay2Exercises] = useState(DEFAULT_DAY_2_EXERCISES);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackupReminder, setShowBackupReminder] = useState(false);
            const [showDayBreakdown, setShowDayBreakdown] = useState(false);
            const [showEditWorkout, setShowEditWorkout] = useState(false);
            const [editingWorkout, setEditingWorkout] = useState(null);
            const [viewingWeek, setViewingWeek] = useState(1);
            const [expandedWeightBreakdown, setExpandedWeightBreakdown] = useState(null);
            const currentWeek = useMemo(() => getCurrentWeek(workoutHistory), [workoutHistory]);
            const hasMigratedWeeks = useRef(false);

            // Wrapper to change day and save to localStorage (sticky session)
            const handleDayChange = (day) => {
                setCurrentDay(day);
                saveActiveDay(day);
            };

            useEffect(() => {
                // Migrate existing data to namespaced storage (one-time for existing users)
                migrateToNamespacedStorage();

                // Load workout history
                const saved = storage.getItem('gymWorkoutHistory');
                if (saved) {
                    const history = JSON.parse(saved);
                    setWorkoutHistory(history);
                }

                // Load custom exercise configurations
                // Check if we need to migrate to Anterior/Posterior split
                const hasMigratedToAP = storage.getItem('migratedToAnteriorPosterior');
                if (!hasMigratedToAP) {
                    // Clear old exercise config and use new defaults
                    storage.removeItem('gymExerciseConfig');
                    storage.setItem('migratedToAnteriorPosterior', 'true');
                }

                // Check if exercise config needs migration (new exercises added/removed)
                // This runs after AP migration and handles ongoing exercise list changes
                const migratedConfig = migrateExerciseConfig();

                // Load the exercise config (either migrated or existing)
                if (migratedConfig) {
                    // Use the freshly migrated config
                    setDay1Exercises(migratedConfig.day1.sort((a, b) => a.order - b.order));
                    setDay2Exercises(migratedConfig.day2.sort((a, b) => a.order - b.order));
                } else {
                    // Load from storage if no migration occurred
                    const savedExercises = storage.getItem('gymExerciseConfig');
                    if (savedExercises) {
                        const config = JSON.parse(savedExercises);
                        if (config.day1) {
                            setDay1Exercises(config.day1.sort((a, b) => a.order - b.order));
                        }
                        if (config.day2) {
                            setDay2Exercises(config.day2.sort((a, b) => a.order - b.order));
                        }
                    }
                }

                // Check last backup reminder
                const lastReminder = storage.getItem('lastBackupReminder');
                const now = new Date().getTime();
                const oneMonth = 30 * 24 * 60 * 60 * 1000;

                if (!lastReminder || (now - parseInt(lastReminder)) > oneMonth) {
                    setShowBackupReminder(true);
                }
            }, []);

            // Update viewing week and migrate workout history when it loads
            useEffect(() => {
                if (workoutHistory.length > 0 && !hasMigratedWeeks.current) {
                    // Clear the cached first workout Monday to recalculate based on actual data
                    storage.removeItem('firstWorkoutMonday');

                    // Recalculate week numbers for all workouts
                    const migratedHistory = workoutHistory.map(workout => ({
                        ...workout,
                        week: getWeekNumber(workout.date, workoutHistory)
                    }));

                    // Only update if week numbers changed
                    const hasChanges = migratedHistory.some((workout, idx) =>
                        workout.week !== workoutHistory[idx].week
                    );

                    if (hasChanges) {
                        setWorkoutHistory(migratedHistory);
                        storage.setItem('gymWorkoutHistory', JSON.stringify(migratedHistory));
                    }

                    // Set viewing week to current week
                    setViewingWeek(currentWeek);

                    // Mark migration as complete
                    hasMigratedWeeks.current = true;
                }
            }, [workoutHistory.length, currentWeek]); // Run when history loads or length changes

            // Restore logged state and workout data from today's workout
            useEffect(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayWorkout = workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });

                if (todayWorkout && !todayWorkout.submitted) {
                    // Only restore state if workout hasn't been submitted yet
                    const newLoggedExercises = {};
                    const newWorkoutData = {};

                    todayWorkout.exercises.forEach(exercise => {
                        // Check if exercise has actual data (not just defaults or empty values)
                        let hasData = false;
                        if (exercise.type === 'assault-bike') {
                            hasData = exercise.watts && exercise.watts !== '' && exercise.watts !== 'NA';
                        } else if (exercise.type === 'stairmaster') {
                            hasData = exercise.time && exercise.time !== '' && exercise.time !== 'NA';
                        } else if (exercise.type === 'bodyweight') {
                            hasData = exercise.reps && exercise.reps !== '' && exercise.reps !== 'NA';
                        } else {
                            hasData = (exercise.weight && exercise.weight !== '' && exercise.weight !== 'NA') ||
                                     (exercise.reps && exercise.reps !== '' && exercise.reps !== 'NA');
                        }

                        if (hasData) {
                            newLoggedExercises[exercise.id] = true;

                            if (exercise.type === 'assault-bike') {
                                newWorkoutData[exercise.id] = { watts: exercise.watts };
                            } else if (exercise.type === 'stairmaster') {
                                newWorkoutData[exercise.id] = { time: exercise.time, level: exercise.level || 'Level 7' };
                            } else if (exercise.type === 'bodyweight') {
                                newWorkoutData[exercise.id] = { reps: exercise.reps };
                            } else {
                                newWorkoutData[exercise.id] = {
                                    weight: exercise.weight,
                                    reps: exercise.reps
                                };
                            }
                        }
                    });

                    setLoggedExercises(newLoggedExercises);
                    setWorkoutData(newWorkoutData);
                } else {
                    // Clear logged state if switching to a day with no workout or if workout is submitted
                    setLoggedExercises({});
                    setWorkoutData({});
                }
            }, [workoutHistory, currentDay]);

            const getCurrentExercises = () => {
                return currentDay === 1 ? day1Exercises : day2Exercises;
            };

            const getTodayWorkout = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });
            };

            const isWorkoutSubmitted = () => {
                const todayWorkout = getTodayWorkout();
                return todayWorkout && todayWorkout.submitted;
            };

            const saveExerciseConfig = (updatedDay1 = day1Exercises, updatedDay2 = day2Exercises) => {
                const config = {
                    day1: updatedDay1,
                    day2: updatedDay2
                };
                storage.setItem('gymExerciseConfig', JSON.stringify(config));
            };

            const updateExerciseName = (day, exerciseId, newName) => {
                if (day === 1) {
                    setDay1Exercises(prev => {
                        const updated = prev.map(ex =>
                            ex.id === exerciseId ? { ...ex, name: newName } : ex
                        );
                        // Save immediately with both days
                        saveExerciseConfig(updated, day2Exercises);
                        return updated;
                    });
                } else {
                    setDay2Exercises(prev => {
                        const updated = prev.map(ex =>
                            ex.id === exerciseId ? { ...ex, name: newName } : ex
                        );
                        // Save immediately with both days
                        saveExerciseConfig(day1Exercises, updated);
                        return updated;
                    });
                }
            };

            const moveExercise = (day, exerciseId, direction) => {
                const exercises = day === 1 ? day1Exercises : day2Exercises;
                const currentIndex = exercises.findIndex(ex => ex.id === exerciseId);

                if (direction === 'up' && currentIndex === 0) return;
                if (direction === 'down' && currentIndex === exercises.length - 1) return;

                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                const reordered = [...exercises];
                [reordered[currentIndex], reordered[newIndex]] = [reordered[newIndex], reordered[currentIndex]];

                // Update order values
                const updated = reordered.map((ex, idx) => ({ ...ex, order: idx }));

                if (day === 1) {
                    setDay1Exercises(updated);
                    saveExerciseConfig(updated, day2Exercises);
                } else {
                    setDay2Exercises(updated);
                    saveExerciseConfig(day1Exercises, updated);
                }
            };

            const getPreviousWorkout = (exerciseId) => {
                if (workoutHistory.length === 0) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find up to 3 most recent workouts with this exercise (excluding today's unsubmitted workout)
                const candidates = [];
                for (let workout of workoutHistory) {
                    if (candidates.length >= 3) break; // Stop after finding 3 candidates

                    const workoutDate = new Date(workout.date);
                    workoutDate.setHours(0, 0, 0, 0);

                    // Skip today's workout only if it's not submitted yet
                    if (workoutDate.getTime() === today.getTime() && workout.day === currentDay && !workout.submitted) {
                        continue;
                    }

                    const exercise = workout.exercises.find(e => e.id === exerciseId);
                    if (exercise) {
                        candidates.push(exercise);
                    }
                }

                // Return first candidate that doesn't have "NA" values (check appropriate field based on exercise type)
                for (let candidate of candidates) {
                    // For assault bike, check watts
                    if (candidate.type === 'assault-bike') {
                        if (candidate.watts && candidate.watts !== 'NA') {
                            return candidate;
                        }
                    }
                    // For stairmaster, check time
                    else if (candidate.type === 'stairmaster') {
                        if (candidate.time && candidate.time !== 'NA') {
                            return candidate;
                        }
                    }
                    // For standard/bodyweight exercises, check reps
                    else {
                        if (candidate.reps && candidate.reps !== 'NA') {
                            return candidate;
                        }
                    }
                }

                // If all candidates have NA values (or no valid candidates), return the most recent one
                return candidates.length > 0 ? candidates[0] : null;
            };

            const handleInputChange = (exerciseId, field, value) => {
                setWorkoutData(prev => ({
                    ...prev,
                    [exerciseId]: {
                        ...prev[exerciseId],
                        [field]: value
                    }
                }));
            };

            const logExercise = (exerciseId) => {
                const exercise = getCurrentExercises().find(e => e.id === exerciseId);
                let data = workoutData[exerciseId] || {};

                // Capture auto-filled weight if user didn't manually enter it
                if (exercise.type === 'standard' && !data.weight && data.reps) {
                    const exerciseCard = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
                    if (exerciseCard) {
                        const weightInput = exerciseCard.querySelector('input[type="number"][inputmode="decimal"]');
                        if (weightInput && weightInput.value) {
                            data = { ...data, weight: weightInput.value };
                        }
                    }
                }
                // For stairmaster, capture displayed time from dropdown if user didn't interact with it
                if (exercise.type === 'stairmaster' && !data.time) {
                    const exerciseCard = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
                    const timeSelect = exerciseCard?.querySelector('select');
                    if (timeSelect && timeSelect.value) {
                        data = { ...data, time: timeSelect.value };
                    }
                }

                if (!data || Object.keys(data).length === 0) return;

                // Validate data based on exercise type
                if (exercise.type === 'assault-bike' && !data.watts) return;
                if (exercise.type === 'stairmaster' && !data.time) return;
                if (exercise.type === 'bodyweight' && !data.reps) return;
                if (exercise.type === 'standard' && !data.weight && !data.reps) return;

                let finalData = { ...data };
                const timestamp = new Date().toISOString();
                finalData.timestamp = timestamp;

                // Save current day as active day (sticky session)
                saveActiveDay(currentDay);

                // Find if there's already a workout for today (that hasn't been submitted)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayWeek = getWeekNumber(today, workoutHistory);

                let existingWorkoutIndex = workoutHistory.findIndex(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    const isNotSubmitted = !w.submitted;
                    return isSameDay && isSameWorkoutDay && isNotSubmitted;
                });

                // Create exercise object to save
                let exerciseToSave;
                if (exercise.type === 'assault-bike') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        intensity: '10/20',
                        watts: finalData.watts || ''
                    };
                } else if (exercise.type === 'stairmaster') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        level: 'Level 10',  // Hardcoded level
                        time: finalData.time || ''
                    };
                } else if (exercise.type === 'bodyweight') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: 'Body Weight',
                        reps: finalData.reps || ''
                    };
                } else {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: finalData.weight || '',
                        reps: finalData.reps || ''
                    };
                }

                let updatedHistory;
                if (existingWorkoutIndex !== -1) {
                    // Update existing workout
                    updatedHistory = [...workoutHistory];
                    const workout = updatedHistory[existingWorkoutIndex];
                    const exerciseIndex = workout.exercises.findIndex(e => e.id === exerciseId);

                    if (exerciseIndex !== -1) {
                        workout.exercises[exerciseIndex] = exerciseToSave;
                    } else {
                        workout.exercises.push(exerciseToSave);
                    }

                    workout.date = timestamp; // Update to latest timestamp
                } else {
                    // Create new workout with all exercises initialized to NA
                    const allExercises = getCurrentExercises().map(ex => {
                        if (ex.id === exerciseId) {
                            return exerciseToSave;
                        } else {
                            // Initialize as NA
                            if (ex.type === 'assault-bike') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    intensity: '10/20',
                                    watts: ''
                                };
                            } else if (ex.type === 'stairmaster') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    level: 'Level 10',  // Hardcoded level
                                    time: ''
                                };
                            } else if (ex.type === 'bodyweight') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: 'Body Weight',
                                    reps: ''
                                };
                            } else {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: '',
                                    reps: ''
                                };
                            }
                        }
                    });

                    const newWorkout = {
                        date: timestamp,
                        day: currentDay,
                        week: todayWeek,
                        exercises: allExercises,
                        submitted: false,
                        plateauBusters: []
                    };

                    updatedHistory = [newWorkout, ...workoutHistory];
                }

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                setLoggedExercises(prev => ({
                    ...prev,
                    [exerciseId]: true
                }));

                setSuccessMessage('Exercise logged!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const completeDay = () => {
                // Find today's workout
                const todayWorkout = getTodayWorkout();

                if (!todayWorkout) {
                    alert('Please log at least one exercise first!');
                    return;
                }

                // Helper to find previous valid workout data for an exercise (up to 5 sessions back, skipping NA)
                const findPreviousValidExercise = (exerciseId) => {
                    // Get previous workouts of the same day type, sorted by date descending
                    // Exclude the current workout being submitted (compare by date string to handle same-day workouts)
                    const previousWorkouts = workoutHistory
                        .filter(w => {
                            // Same day type
                            if (w.day !== currentDay) return false;
                            // Exclude the current workout being submitted
                            if (w.date === todayWorkout.date) return false;
                            // Must be submitted
                            if (!w.submitted) return false;
                            return true;
                        })
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5); // Check up to 5 sessions back

                    // Find first workout with valid (non-NA) data for this exercise
                    for (const workout of previousWorkouts) {
                        const exercise = workout.exercises.find(e => e.id === exerciseId);
                        if (exercise && exercise.reps && exercise.reps !== 'NA' &&
                            (exercise.type === 'bodyweight' || (exercise.weight && exercise.weight !== 'NA'))) {
                            return exercise;
                        }
                    }
                    return null;
                };

                // Detect exercises for plateau busting
                // Rules:
                // - reps < 6: ALWAYS plateau buster
                // - reps 6-7: plateau buster IF weight <= previous weight AND reps <= previous reps
                // - reps 8+: no plateau buster (PR system handles this)
                const plateauBusters = [];
                console.log('[completeDay] Checking for plateau busters in:', todayWorkout);
                todayWorkout.exercises.forEach(exercise => {
                    // Only check standard and bodyweight exercises (those with reps)
                    if ((exercise.type === 'standard' || exercise.type === 'bodyweight') && exercise.reps && exercise.reps !== 'NA') {
                        const reps = parseInt(exercise.reps);
                        console.log('[completeDay] Exercise:', exercise.name, 'Reps:', reps);

                        if (isNaN(reps)) return;

                        // Rule 1: Less than 6 reps ALWAYS triggers plateau buster
                        if (reps < 6) {
                            console.log('[completeDay] PLATEAU BUSTER (< 6 reps) detected for:', exercise.name);
                            plateauBusters.push(exercise.id);
                            return;
                        }

                        // Rule 2: 6-7 reps triggers plateau buster only if weight AND reps are not improving
                        // BUT skip if already in plateau buster recovery (previous session had this as plateau buster)
                        if (reps >= 6 && reps <= 7) {
                            // Check if previous session already had this as a plateau buster
                            const previousWorkoutWithPlateau = workoutHistory
                                .filter(w => {
                                    if (w.day !== currentDay) return false;
                                    if (w.date === todayWorkout.date) return false;
                                    if (!w.submitted) return false;
                                    const ex = w.exercises.find(e => e.id === exercise.id);
                                    return ex && ex.reps && ex.reps !== 'NA';
                                })
                                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                            if (previousWorkoutWithPlateau?.plateauBusters?.includes(exercise.id)) {
                                console.log('[completeDay] Already in plateau buster recovery, skipping chain for:', exercise.name);
                                return; // Don't chain - retry system handles this
                            }

                            const previousExercise = findPreviousValidExercise(exercise.id);

                            if (previousExercise) {
                                const previousReps = parseInt(previousExercise.reps) || 0;

                                // For bodyweight exercises, trigger plateau buster only if reps didn't improve
                                if (exercise.type === 'bodyweight') {
                                    if (reps <= previousReps) {
                                        console.log('[completeDay] PLATEAU BUSTER (bodyweight 6-7 reps, no rep improvement) detected for:', exercise.name);
                                        plateauBusters.push(exercise.id);
                                    } else {
                                        console.log('[completeDay] Neutral (bodyweight 6-7 reps but reps improved) for:', exercise.name);
                                    }
                                    return;
                                }

                                const currentWeight = parseFloat(exercise.weight) || 0;
                                const previousWeight = parseFloat(previousExercise.weight) || 0;

                                // Plateau buster only if: weight not increased AND reps not increased
                                if (currentWeight <= previousWeight && reps <= previousReps) {
                                    console.log('[completeDay] PLATEAU BUSTER (6-7 reps, no progress) detected for:', exercise.name);
                                    console.log('[completeDay] Current:', currentWeight, 'lbs ', reps, '| Previous:', previousWeight, 'lbs ', previousReps);
                                    plateauBusters.push(exercise.id);
                                } else if (currentWeight > previousWeight) {
                                    console.log('[completeDay] Neutral (6-7 reps but weight increased) for:', exercise.name);
                                } else {
                                    console.log('[completeDay] Neutral (6-7 reps but reps improved) for:', exercise.name);
                                }
                            } else {
                                // No previous data - treat 6-7 reps as neutral (not enough history to compare)
                                console.log('[completeDay] No previous data for comparison, treating as neutral:', exercise.name);
                            }
                        }

                        // Rule 3: 8+ reps - no plateau buster (PR system handles this)
                    }
                });
                console.log('[completeDay] Total plateau busters:', plateauBusters);

                // Mark workout as submitted (immutable) and add plateau busters
                const updatedHistory = workoutHistory.map(w => {
                    if (w === todayWorkout) {
                        return { ...w, submitted: true, plateauBusters };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                // Automatically backup to Downloads folder
                autoBackup();

                // Reset all log states so exercises act like a fresh day
                setLoggedExercises({});
                setWorkoutData({});

                setShowDayBreakdown(true);
            };

            const markDayAsNA = () => {
                if (!confirm('Are you sure you want to mark this day as NA?')) {
                    return;
                }

                const timestamp = new Date().toISOString();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayWeek = getWeekNumber(today, workoutHistory);

                // Get all exercises for the current day
                const currentDayExercises = getCurrentExercises();

                // Create NA entries for all exercises based on their type
                const naExercises = currentDayExercises.map(ex => {
                    if (ex.type === 'assault-bike') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            intensity: '10/20',
                            watts: 'NA'
                        };
                    } else if (ex.type === 'stairmaster') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            level: 'Level 10',  // Hardcoded level
                            time: 'NA'
                        };
                    } else if (ex.type === 'bodyweight') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            weight: 'Body Weight',
                            reps: 'NA'
                        };
                    } else {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            weight: 'NA',
                            reps: 'NA'
                        };
                    }
                });

                // Find if there's already a workout for today with the same day number (that hasn't been submitted)
                let existingWorkoutIndex = workoutHistory.findIndex(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    const isNotSubmitted = !w.submitted;
                    return isSameDay && isSameWorkoutDay && isNotSubmitted;
                });

                let updatedHistory;
                if (existingWorkoutIndex !== -1) {
                    // Update existing workout with NA values and mark as submitted
                    updatedHistory = [...workoutHistory];
                    updatedHistory[existingWorkoutIndex] = {
                        ...updatedHistory[existingWorkoutIndex],
                        exercises: naExercises,
                        date: timestamp,
                        submitted: true,
                        plateauBusters: []
                    };
                } else {
                    // Create new workout and mark as submitted
                    const newWorkout = {
                        date: timestamp,
                        day: currentDay,
                        week: todayWeek,
                        exercises: naExercises,
                        submitted: true,
                        plateauBusters: []
                    };
                    updatedHistory = [newWorkout, ...workoutHistory];
                }

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                // Automatically backup to Downloads folder
                autoBackup();

                // Reset all log states so exercises act like a fresh day
                setLoggedExercises({});
                setWorkoutData({});

                // Show the breakdown modal
                setShowDayBreakdown(true);
            };

            const updateWorkout = (workoutDate, updatedExercises) => {
                const updatedHistory = workoutHistory.map(w => {
                    if (w.date === workoutDate) {
                        return { ...w, exercises: updatedExercises };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));
                setSuccessMessage('Workout updated!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const exportData = () => {
                const exportObj = {
                    workoutHistory,
                    exerciseConfig: {
                        day1: day1Exercises
                    },
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const autoBackup = () => {
                const exportObj = {
                    workoutHistory,
                    exerciseConfig: {
                        day1: day1Exercises
                    },
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `gym-tracker-AUTO-BACKUP-${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);

                        // Handle old format (just workout history array) or new format (object with configs)
                        if (Array.isArray(imported)) {
                            // Old format
                            setWorkoutHistory(imported);
                            storage.setItem('gymWorkoutHistory', JSON.stringify(imported));
                        } else {
                            // New format
                            if (imported.workoutHistory) {
                                setWorkoutHistory(imported.workoutHistory);
                                storage.setItem('gymWorkoutHistory', JSON.stringify(imported.workoutHistory));
                            }
                            if (imported.exerciseConfig) {
                                if (imported.exerciseConfig.day1) {
                                    setDay1Exercises(imported.exerciseConfig.day1.sort((a, b) => a.order - b.order));
                                }
                                storage.setItem('gymExerciseConfig', JSON.stringify({ day1: imported.exerciseConfig.day1 }));
                            }
                        }

                        setSuccessMessage('Data imported successfully!');
                        setShowSuccess(true);
                        setTimeout(() => setShowSuccess(false), 3000);
                        setShowSettings(false);
                    } catch (error) {
                        alert('Invalid backup file');
                    }
                };
                reader.readAsText(file);
            };

            const resetData = () => {
                if (confirm('ARE YOU VERY SURE? This will delete ALL your workout data AND exercise customizations permanently. This cannot be undone!')) {
                    if (confirm('FINAL WARNING: All your progress and custom exercise names/order will be lost forever. Continue?')) {
                        storage.removeItem('gymWorkoutHistory');
                        storage.removeItem('gymExerciseConfig');
                        storage.removeItem('lastBackupReminder');
                        setWorkoutHistory([]);
                        setWorkoutData({});
                        setLoggedExercises({});
                        setDay1Exercises(DEFAULT_DAY_1_EXERCISES);
                        setShowSettings(false);
                        setSuccessMessage('All data has been reset');
                        setShowSuccess(true);
                        setTimeout(() => setShowSuccess(false), 3000);
                    }
                }
            };

            const dismissBackupReminder = () => {
                storage.setItem('lastBackupReminder', new Date().getTime().toString());
                setShowBackupReminder(false);
            };

            return (
                <div className="app">
                    {showSuccess && <div className={`success-message ${showBackupReminder ? 'backup-reminder' : ''}`}>{successMessage}</div>}

                    {showBackupReminder && (
                        <BackupReminderModal
                            onExport={() => { exportData(); dismissBackupReminder(); }}
                            onDismiss={dismissBackupReminder}
                        />
                    )}

                    {showSettings && (
                        <SettingsModal
                            onClose={() => setShowSettings(false)}
                            onExport={exportData}
                            onImport={importData}
                            onReset={resetData}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                            updateExerciseName={updateExerciseName}
                            moveExercise={moveExercise}
                        />
                    )}

                    {showDayBreakdown && (
                        <DayBreakdownModal
                            onClose={() => setShowDayBreakdown(false)}
                            workoutHistory={workoutHistory}
                            currentDay={currentDay}
                            getCurrentExercises={getCurrentExercises}
                            getPreviousWorkout={getPreviousWorkout}
                        />
                    )}

                    {showEditWorkout && editingWorkout && (
                        <EditWorkoutModal
                            workout={editingWorkout}
                            onClose={() => {
                                setShowEditWorkout(false);
                                setEditingWorkout(null);
                            }}
                            onSave={updateWorkout}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                        />
                    )}

                    <div className="header">
                        <div className="header-top">
                            <h1>Gym Tracker</h1>
                            <button className="settings-btn" onClick={() => setShowSettings(true)}></button>
                        </div>
                        <div className="week-indicator">Week {currentWeek}</div>
                        <div className="nav">
                            <button
                                className={`nav-btn ${currentView === 'workout' ? 'active' : ''}`}
                                onClick={() => setCurrentView('workout')}
                            >
                                Workout
                            </button>
                            <button
                                className={`nav-btn ${currentView === 'weekly' ? 'active' : ''}`}
                                onClick={() => { setCurrentView('weekly'); setViewingWeek(currentWeek); window.scrollTo(0, 0); }}
                            >
                                Weekly
                            </button>
                        </div>
                    </div>

                    <div className="content">
                        {currentView === 'workout' && <WorkoutView
                            currentDay={currentDay}
                            setCurrentDay={handleDayChange}
                            workoutData={workoutData}
                            loggedExercises={loggedExercises}
                            handleInputChange={handleInputChange}
                            getPreviousWorkout={getPreviousWorkout}
                            logExercise={logExercise}
                            completeDay={completeDay}
                            markDayAsNA={markDayAsNA}
                            getCurrentExercises={getCurrentExercises}
                            currentWeek={currentWeek}
                            workoutHistory={workoutHistory}
                            expandedWeightBreakdown={expandedWeightBreakdown}
                            setExpandedWeightBreakdown={setExpandedWeightBreakdown}
                        />}
                        {currentView === 'weekly' && <WeeklyView
                            workoutHistory={workoutHistory}
                            viewingWeek={viewingWeek}
                            setViewingWeek={setViewingWeek}
                            currentWeek={currentWeek}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                            onEditWorkout={(workout) => {
                                setEditingWorkout(workout);
                                setShowEditWorkout(true);
                            }}
                        />}
                    </div>
                </div>
            );
        }

        function BackupReminderModal({ onExport, onDismiss }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-title"> Backup Reminder</div>
                        <p style={{ color: '#888', marginBottom: '20px', fontSize: '14px' }}>
                            It's been a month! Back up your workout data to keep it safe.
                        </p>
                        <button className="modal-btn primary" onClick={onExport}>
                            Download Backup
                        </button>
                        <button className="modal-btn" onClick={onDismiss}>
                            Remind Me Later
                        </button>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose, onExport, onImport, onReset, day1Exercises, day2Exercises, updateExerciseName, moveExercise }) {
            const fileInputRef = useRef();
            const [settingsView, setSettingsView] = useState('main'); // 'main', 'exercises'
            const [editingExercise, setEditingExercise] = useState(null);
            const [tempName, setTempName] = useState('');

            const handleStartEdit = (exercise) => {
                setEditingExercise(exercise.id);
                setTempName(exercise.name);
            };

            const handleSaveEdit = (day, exerciseId) => {
                if (tempName.trim()) {
                    updateExerciseName(day, exerciseId, tempName.trim());
                }
                setEditingExercise(null);
                setTempName('');
            };

            const handleCancelEdit = () => {
                setEditingExercise(null);
                setTempName('');
            };

            if (settingsView === 'exercises-day1' || settingsView === 'exercises-day2') {
                const day = settingsView === 'exercises-day1' ? 1 : 2;
                const exercises = day === 1 ? day1Exercises : day2Exercises;
                const dayName = day === 1 ? 'Anterior' : 'Posterior';

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px', maxHeight: '80vh', overflowY: 'auto' }}>
                            <div className="modal-title">{dayName} Day Exercises</div>

                            <div style={{ marginBottom: '20px' }}>
                                {exercises.map((exercise, idx) => (
                                    <div key={exercise.id} style={{
                                        background: '#1a1a2a',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        marginBottom: '8px',
                                        border: '1px solid #2a2a3a'
                                    }}>
                                        {editingExercise === exercise.id ? (
                                            <div>
                                                <input
                                                    type="text"
                                                    value={tempName}
                                                    onChange={(e) => setTempName(e.target.value)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '8px',
                                                        background: '#0d0d1a',
                                                        border: '1px solid #3a2a5a',
                                                        borderRadius: '4px',
                                                        color: '#b8b8d0',
                                                        marginBottom: '8px'
                                                    }}
                                                    autoFocus
                                                />
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => handleSaveEdit(day, exercise.id)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '6px',
                                                            background: '#3a2a5a',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            color: '#b8b8d0',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Save
                                                    </button>
                                                    <button
                                                        onClick={handleCancelEdit}
                                                        style={{
                                                            flex: 1,
                                                            padding: '6px',
                                                            background: '#1a1a2a',
                                                            border: '1px solid #2a2a3a',
                                                            borderRadius: '4px',
                                                            color: '#8a8aa0',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <div style={{ flex: 1, fontWeight: '600' }}>
                                                    {exercise.name}
                                                </div>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'up')}
                                                    disabled={idx === 0}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === 0 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === 0 ? '#555' : '#8a8aa0',
                                                        cursor: idx === 0 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    
                                                    </button>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'down')}
                                                    disabled={idx === exercises.length - 1}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === exercises.length - 1 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === exercises.length - 1 ? '#555' : '#8a8aa0',
                                                        cursor: idx === exercises.length - 1 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    
                                                </button>
                                                <button
                                                    onClick={() => handleStartEdit(exercise)}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: '#8a8aa0',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <button className="modal-btn" onClick={() => setSettingsView('main')}>
                                 Back to Settings
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-title">Settings</div>

                        <button className="modal-btn" onClick={() => setSettingsView('exercises-day1')}>
                             Manage Anterior Day Exercises
                        </button>
                        <button className="modal-btn" onClick={() => setSettingsView('exercises-day2')}>
                             Manage Posterior Day Exercises
                        </button>

                        <div style={{ height: '1px', background: '#2a2a3a', margin: '12px 0' }}></div>

                        <button className="modal-btn" onClick={onExport}>
                             Export Data
                        </button>
                        <button className="modal-btn" onClick={() => fileInputRef.current.click()}>
                             Import Data
                        </button>
                        <button className="modal-btn danger" onClick={onReset}>
                             Reset All Data
                        </button>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".json"
                            className="file-input"
                            onChange={onImport}
                        />
                        <button className="modal-btn" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function EditWorkoutModal({ workout, onClose, onSave, day1Exercises, day2Exercises }) {
            const [editedExercises, setEditedExercises] = useState(workout.exercises);
            const allExercises = workout.day === 1 ? day1Exercises : day2Exercises;

            const handleExerciseChange = (exerciseId, field, value) => {
                setEditedExercises(prev => {
                    const updated = [...prev];
                    const exerciseIndex = updated.findIndex(e => e.id === exerciseId);
                    if (exerciseIndex !== -1) {
                        // Exercise exists - update it
                        updated[exerciseIndex] = {
                            ...updated[exerciseIndex],
                            [field]: value
                        };
                    } else {
                        // Exercise doesn't exist in workout data - add it
                        // Find the exercise definition from allExercises
                        const exerciseDef = allExercises.find(e => e.id === exerciseId);
                        if (exerciseDef) {
                            updated.push({
                                id: exerciseDef.id,
                                name: exerciseDef.name,
                                category: exerciseDef.category,
                                type: exerciseDef.type,
                                [field]: value
                            });
                        }
                    }
                    return updated;
                });
            };

            const handleSave = () => {
                onSave(workout.date, editedExercises);
                onClose();
            };

            const date = new Date(workout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            // Show "Full Body" for day 1 workouts before the Anterior/Posterior split (Feb 2, 2026)
            const splitDate = new Date(2026, 1, 2);
            splitDate.setHours(0, 0, 0, 0);
            const workoutDate = new Date(workout.date);
            workoutDate.setHours(0, 0, 0, 0);
            const isBeforeSplit = workoutDate < splitDate;
            const dayName = workout.day === 1
                ? (isBeforeSplit ? 'Upper' : 'Anterior')
                : (isBeforeSplit ? 'Lower' : 'Posterior');

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px', maxHeight: '80vh', overflowY: 'auto' }}>
                        <div className="modal-title">Edit Workout - {dayName} Day</div>
                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        {allExercises.map((exercise) => {
                            const editedExercise = editedExercises.find(e => e.id === exercise.id);

                            return (
                                <div key={exercise.id} style={{
                                    background: '#1a1a2a',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    marginBottom: '12px',
                                    border: '1px solid #2a2a3a'
                                }}>
                                    <div style={{ fontWeight: '600', marginBottom: '8px' }}>
                                        {exercise.name}
                                    </div>
                                    {exercise.type === 'assault-bike' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="10/20"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Watts"
                                                value={editedExercise?.watts || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'watts', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : exercise.type === 'stairmaster' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="Level 10"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                            <select
                                                value={editedExercise?.time || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'time', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            >
                                                <option value="">Select time</option>
                                                {(() => {
                                                    const timeOptions = [];
                                                    for (let minutes = 5; minutes <= 20; minutes++) {
                                                        for (let seconds = 0; seconds < 60; seconds += 15) {
                                                            if (minutes === 20 && seconds > 0) break;
                                                            const time = formatSecondsToTime(minutes * 60 + seconds);
                                                            timeOptions.push(<option key={time} value={time}>{time}</option>);
                                                        }
                                                    }
                                                    return timeOptions;
                                                })()}
                                            </select>
                                        </div>
                                    ) : exercise.type === 'bodyweight' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="Body Weight"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="number"
                                                placeholder="Weight"
                                                value={editedExercise?.weight || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'weight', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <div style={{ display: 'flex', gap: '8px', marginTop: '20px' }}>
                            <button className="modal-btn primary" onClick={handleSave} style={{ flex: 1 }}>
                                Save Changes
                            </button>
                            <button className="modal-btn" onClick={onClose} style={{ flex: 1 }}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function DayBreakdownModal({ onClose, workoutHistory, currentDay, getCurrentExercises, getPreviousWorkout }) {
            // Find today's workout
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayWorkout = workoutHistory.find(w => {
                const workoutDate = new Date(w.date);
                workoutDate.setHours(0, 0, 0, 0);
                const isSameDay = workoutDate.getTime() === today.getTime();
                const isSameWorkoutDay = w.day === currentDay;
                return isSameDay && isSameWorkoutDay;
            });

            if (!todayWorkout) {
                return null;
            }

            // Function to get most recent previous workout for the same exercise (looks back up to 3 sessions, skips NA)
            const getPreviousWorkoutForExercise = (exerciseId) => {
                const todayDate = new Date(todayWorkout.date);

                console.log('Looking for previous workout for:', exerciseId, 'Current day type:', currentDay);

                // Find up to 3 most recent workouts of the same day type (before today) with this exercise
                const candidates = [];
                const sortedWorkouts = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        return w.day === currentDay && workoutDate < todayDate;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                for (let workout of sortedWorkouts) {
                    if (candidates.length >= 3) break; // Stop after finding 3 candidates

                    const exercise = workout.exercises.find(e => e.id === exerciseId);
                    if (exercise) {
                        candidates.push(exercise);
                    }
                }

                console.log('Found', candidates.length, 'candidate(s)');

                // Return first candidate that doesn't have "NA" values (check appropriate field based on exercise type)
                for (let candidate of candidates) {
                    // For assault bike, check watts
                    if (candidate.type === 'assault-bike') {
                        if (candidate.watts && candidate.watts !== 'NA') {
                            console.log('Returning valid assault-bike workout with watts:', candidate.watts);
                            return candidate;
                        }
                    }
                    // For stairmaster, check time
                    else if (candidate.type === 'stairmaster') {
                        if (candidate.time && candidate.time !== 'NA') {
                            console.log('Returning valid stairmaster workout with time:', candidate.time);
                            return candidate;
                        }
                    }
                    // For standard/bodyweight exercises, check reps
                    else {
                        if (candidate.reps && candidate.reps !== 'NA') {
                            console.log('Returning valid workout with reps:', candidate.reps);
                            return candidate;
                        }
                    }
                }

                console.log('All candidates have NA values or no valid candidates found');
                // If all candidates have NA values (or no valid candidates), return the most recent one
                return candidates.length > 0 ? candidates[0] : null;
            };

            // Get only exercises that match the current day
            const currentDayExerciseIds = new Set(getCurrentExercises().map(e => e.id));
            const currentDayWorkoutExercises = todayWorkout.exercises.filter(e => currentDayExerciseIds.has(e.id));

            // Calculate PRs (just count them)
            let prCount = 0;
            currentDayWorkoutExercises.forEach(exercise => {
                if (!exercise.weight && !exercise.reps && !exercise.watts && !exercise.time) {
                    return; // Skip NA exercises
                }

                const previous = getPreviousWorkoutForExercise(exercise.id);
                if (!previous) {
                    console.log('No previous data for:', exercise.name);
                    return; // Skip if no previous workout
                }

                let isPR = false;

                if (exercise.type === 'assault-bike') {
                    if (parseInt(exercise.watts) > parseInt(previous.watts || 0)) {
                        isPR = true;
                    }
                } else if (exercise.type === 'stairmaster') {
                    const currentSeconds = parseTimeToSeconds(exercise.time);
                    const previousSeconds = parseTimeToSeconds(previous.time);
                    if (currentSeconds > previousSeconds) {
                        isPR = true;
                    }
                } else if (exercise.type === 'bodyweight') {
                    const currentReps = parseInt(exercise.reps);
                    const previousReps = parseInt(previous.reps || 0);
                    console.log('Bodyweight comparison:', exercise.name, 'Current:', currentReps, 'Previous:', previousReps);
                    if (currentReps > previousReps && currentReps >= 6) {
                        isPR = true;
                    }
                } else {
                    // Standard exercise - PR if weight OR reps increased (and reps >= 6)
                    const currentWeight = parseFloat(exercise.weight);
                    const previousWeight = parseFloat(previous.weight);
                    const currentReps = parseInt(exercise.reps);
                    const previousReps = parseInt(previous.reps);

                    console.log('Standard comparison:', exercise.name, 'Current:', currentWeight, 'lbs x', currentReps, 'Previous:', previousWeight, 'lbs x', previousReps);

                    if ((currentWeight > previousWeight || currentReps > previousReps) && currentReps >= 6) {
                        isPR = true;
                    }
                }

                if (isPR) {
                    console.log('PR detected for:', exercise.name);
                    prCount++;
                }
            });

            console.log('Total PR count:', prCount);

            // Count completed exercises (only for current day, excluding NA)
            const completedCount = currentDayWorkoutExercises.filter(e => {
                // Check if exercise has valid data (not NA)
                if (e.type === 'assault-bike') {
                    return e.watts && e.watts !== 'NA';
                } else if (e.type === 'stairmaster') {
                    return e.time && e.time !== 'NA';
                } else if (e.type === 'bodyweight') {
                    return e.reps && e.reps !== 'NA';
                } else {
                    return (e.weight && e.weight !== 'NA') || (e.reps && e.reps !== 'NA');
                }
            }).length;
            const totalCount = getCurrentExercises().length;

            const date = new Date(todayWorkout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                        <div className="modal-title">{currentDay === 1 ? 'Anterior' : 'Posterior'} Day Breakdown</div>

                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '10px' }}>
                                Exercises Completed
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: '#3a2a5a' }}>
                                {completedCount} / {totalCount}
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '10px' }}>
                                PRs Smashed
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: '#3a2a5a' }}>
                                {prCount}
                            </div>
                        </div>

                        <button className="modal-btn primary" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function WorkoutView({ currentDay, setCurrentDay, workoutData, loggedExercises, handleInputChange, getPreviousWorkout, logExercise, completeDay, markDayAsNA, getCurrentExercises, currentWeek, userBodyweight, workoutHistory, expandedWeightBreakdown, setExpandedWeightBreakdown }) {
            const exercises = getCurrentExercises();
            const anteriorExercises = exercises.filter(e => e.category === 'Anterior');
            const posteriorExercises = exercises.filter(e => e.category === 'Posterior');
            const cardioExercises = exercises.filter(e => e.category === 'Cardio');

            // Helper function to check if an exercise has valid data (not NA)
            const isValidExercise = (exercise) => {
                if (!exercise) return false;
                if (exercise.reps === 'NA' || exercise.weight === 'NA') return false;
                if (!exercise.reps || !exercise.weight) return false;
                return true;
            };

            // Helper function to check if exercise is marked for plateau busting
            const isPlateauBuster = (exerciseId) => {
                if (!workoutHistory || workoutHistory.length === 0) return false;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout of the same day type with valid data for this exercise
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                if (!previousWorkout || !previousWorkout.plateauBusters) return false;

                return previousWorkout.plateauBusters.includes(exerciseId);
            };

            // Helper function to check if this is a PR Weight Recovery week (week after plateau buster)
            const getPRWeightRecovery = (exerciseId) => {
                if (!workoutHistory || workoutHistory.length < 2) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get the two most recent previous workouts of the same day type with valid data
                const previousWorkouts = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (previousWorkouts.length < 2) return null;

                const lastWeek = previousWorkouts[0];
                const twoWeeksAgo = previousWorkouts[1];

                // Check if two weeks ago had this exercise as a plateau buster
                // That means last week the user saw the gold plateau buster reminder
                // This week they should see green and recover to the original weight
                // BUT only if last week hit 8+ reps (plateau buster success)
                if (twoWeeksAgo.plateauBusters && twoWeeksAgo.plateauBusters.includes(exerciseId)) {
                    const lastWeekExercise = lastWeek.exercises.find(e => e.id === exerciseId);
                    const twoWeeksExercise = twoWeeksAgo.exercises.find(e => e.id === exerciseId);

                    // Only trigger Trial of Strength if last week hit 8+ reps
                    if (lastWeekExercise && lastWeekExercise.reps && parseInt(lastWeekExercise.reps) >= 8) {
                        if (twoWeeksExercise && twoWeeksExercise.weight) {
                            return {
                                weight: twoWeeksExercise.weight,
                                reps: '6'  // Always show 6 as the target for Trial of Strength
                            };
                        }
                    }
                    // If last week didn't hit 8 reps, return null so other logic can handle it
                }

                return null;
            };

            // Helper function to handle failed plateau buster (got 6-7 reps, need to retry)
            const getFailedPlateauBusterRetry = (exerciseId) => {
                if (!workoutHistory || workoutHistory.length < 2) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get the two most recent previous workouts of the same day type with valid data
                const previousWorkouts = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (previousWorkouts.length < 2) return null;

                const lastWeek = previousWorkouts[0];
                const twoWeeksAgo = previousWorkouts[1];

                // Check if two weeks ago had a plateau buster and last week got 6-7 reps (failed plateau buster)
                if (twoWeeksAgo.plateauBusters && twoWeeksAgo.plateauBusters.includes(exerciseId)) {
                    const lastWeekExercise = lastWeek.exercises.find(e => e.id === exerciseId);

                    if (lastWeekExercise && lastWeekExercise.reps && lastWeekExercise.weight) {
                        const lastReps = parseInt(lastWeekExercise.reps);

                        // If got 6-7 reps (didn't hit the 8 rep goal), suggest same weight but reps+1
                        if (lastReps >= 6 && lastReps < 8) {
                            return {
                                weight: lastWeekExercise.weight,
                                targetReps: (lastReps + 1).toString(),
                                lastReps: lastWeekExercise.reps
                            };
                        }
                    }
                }

                return null;
            };

            // Helper function to check if this is a PR Auto-Regulation week (after hitting 8+ reps)
            const getPRAutoRegulation = (exerciseId) => {
                console.log('[getPRAutoRegulation] Checking for:', exerciseId);
                if (!workoutHistory || workoutHistory.length === 0) {
                    console.log('[getPRAutoRegulation] No workout history');
                    return null;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout with valid data
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                console.log('[getPRAutoRegulation] Previous workout:', previousWorkout);

                if (!previousWorkout) {
                    console.log('[getPRAutoRegulation] No previous workout found');
                    return null;
                }

                const previousExercise = previousWorkout.exercises.find(e => e.id === exerciseId);
                console.log('[getPRAutoRegulation] Previous exercise:', previousExercise);

                // Check if last week hit a PR (8+ reps) and has a weight increment defined
                if (previousExercise && previousExercise.reps && parseInt(previousExercise.reps) >= 8 &&
                    previousExercise.weight && PR_WEIGHT_INCREMENTS[exerciseId]) {
                    const lastWeight = parseFloat(previousExercise.weight);
                    const increment = PR_WEIGHT_INCREMENTS[exerciseId];
                    const newWeight = (lastWeight + increment).toString();

                    console.log('[getPRAutoRegulation] PR DETECTED! Last:', lastWeight, 'lbs x', previousExercise.reps, 'New:', newWeight);

                    return {
                        weight: newWeight,
                        lastWeight: previousExercise.weight,
                        lastReps: previousExercise.reps,
                        increment: increment
                    };
                }

                console.log('[getPRAutoRegulation] No PR (reps < 8 or missing data)');
                return null;
            };

            // Helper function for assault bike PR detection (+25 watts from last workout)
            const getAssaultBikePR = () => {
                if (!workoutHistory || workoutHistory.length === 0) {
                    return null;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find the most recent workout with valid assault bike data
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        // Exclude future workouts
                        if (workoutDate > today) return false;
                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid assault bike data
                        const assaultBike = w.exercises.find(e => e.id === 'assault-bike');
                        return assaultBike && assaultBike.watts && assaultBike.watts !== 'NA';
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                if (!previousWorkout) return null;

                const lastAssaultBike = previousWorkout.exercises.find(e => e.id === 'assault-bike');

                if (lastAssaultBike && lastAssaultBike.watts) {
                    const lastWatts = parseInt(lastAssaultBike.watts);
                    const newWatts = lastWatts + 25;

                    return {
                        watts: newWatts.toString(),
                        lastWatts: lastAssaultBike.watts
                    };
                }

                return null;
            };

            // Helper function for stairmaster time suggestion (+15 seconds from last workout, cap at 20:00)
            // exerciseId parameter allows independent tracking per day (e.g. 'stairmaster' vs 'stairmaster-anterior')
            const getStairmasterSuggestion = (exerciseId = 'stairmaster') => {
                if (!workoutHistory || workoutHistory.length === 0) {
                    return { time: '5:00', isFirstSession: true };
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find the most recent workout with valid stairmaster data for this specific exercise
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (workoutDate > today) return false;
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        const stairmaster = w.exercises.find(e => e.type === 'stairmaster');
                        return stairmaster && stairmaster.time && stairmaster.time !== 'NA';
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                if (!previousWorkout) {
                    return { time: '5:00', isFirstSession: true };
                }

                const lastStairmaster = previousWorkout.exercises.find(e => e.type === 'stairmaster');

                if (lastStairmaster && lastStairmaster.time) {
                    const lastSeconds = parseTimeToSeconds(lastStairmaster.time);
                    const newSeconds = Math.min(lastSeconds + 15, 20 * 60); // Cap at 20:00

                    return {
                        time: formatSecondsToTime(newSeconds),
                        lastTime: lastStairmaster.time,
                        isFirstSession: false
                    };
                }

                return { time: '5:00', isFirstSession: true };
            };

            // Helper function for plateau buster weight decrement
            const getPlateauBusterDecrement = (exerciseId) => {
                console.log('[getPlateauBusterDecrement] Checking for:', exerciseId);
                if (!workoutHistory || workoutHistory.length === 0) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout with valid data
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                console.log('[getPlateauBusterDecrement] Previous workout:', previousWorkout);
                console.log('[getPlateauBusterDecrement] Plateau busters:', previousWorkout?.plateauBusters);

                if (!previousWorkout || !previousWorkout.plateauBusters || !previousWorkout.plateauBusters.includes(exerciseId)) {
                    console.log('[getPlateauBusterDecrement] Not a plateau buster');
                    return null;
                }

                const previousExercise = previousWorkout.exercises.find(e => e.id === exerciseId);

                // Only drop weight if previous reps were < 6 (true failure)
                // For 6-7 reps stagnation, keep same weight (just do 2 sets)
                const previousReps = parseInt(previousExercise?.reps) || 0;
                if (previousReps >= 6) {
                    console.log('[getPlateauBusterDecrement] Previous reps were', previousReps, '(>= 6), no weight drop needed');
                    return null;
                }

                // Decrease weight by the increment amount (only for < 6 reps)
                if (previousExercise && previousExercise.weight && PR_WEIGHT_INCREMENTS[exerciseId]) {
                    const lastWeight = parseFloat(previousExercise.weight);
                    const increment = PR_WEIGHT_INCREMENTS[exerciseId];
                    const newWeight = (lastWeight - increment).toString();

                    console.log('[getPlateauBusterDecrement] PLATEAU BUSTER! Last:', lastWeight, 'New:', newWeight);

                    return {
                        weight: newWeight,
                        lastWeight: previousExercise.weight,
                        increment: increment
                    };
                }

                console.log('[getPlateauBusterDecrement] Missing data');
                return null;
            };

            // Calculate plate breakdown for a given weight
            const calculatePlateBreakdown = (totalWeight, exerciseId) => {
                const config = PLATE_LOADED_EXERCISES[exerciseId];
                if (!config) return null;

                const availablePlates = [45, 25, 10, 5, 2.5, 1.25];

                // Helper function to break down weight into plates
                const breakdownWeight = (weight) => {
                    const plates = {};
                    let remaining = weight;

                    for (const plate of availablePlates) {
                        const count = Math.floor(remaining / plate);
                        if (count > 0) {
                            plates[plate] = count;
                            remaining = parseFloat((remaining - (count * plate)).toFixed(2));
                        }
                    }

                    return plates;
                };

                // Calculate warmup and top set weights
                const warmup1Weight = totalWeight * 0.5;  // 50%
                const warmup2Weight = totalWeight * 0.75; // 75%
                const topSetWeight = totalWeight;

                // For two-sided machines, divide by 2 to get per-side weight
                const isTwoSided = config.type === 'two-sided';

                const warmup1PerSide = isTwoSided ? warmup1Weight / 2 : warmup1Weight;
                const warmup2PerSide = isTwoSided ? warmup2Weight / 2 : warmup2Weight;
                const topSetPerSide = isTwoSided ? topSetWeight / 2 : topSetWeight;

                return {
                    isTwoSided,
                    warmup1: {
                        totalWeight: warmup1Weight,
                        perSideWeight: warmup1PerSide,
                        plates: breakdownWeight(warmup1PerSide)
                    },
                    warmup2: {
                        totalWeight: warmup2Weight,
                        perSideWeight: warmup2PerSide,
                        plates: breakdownWeight(warmup2PerSide)
                    },
                    topSet: {
                        totalWeight: topSetWeight,
                        perSideWeight: topSetPerSide,
                        plates: breakdownWeight(topSetPerSide)
                    }
                };
            };

            // Calculate warmup sets for pin-stack exercises
            const calculatePinStackWarmups = (totalWeight) => {
                // Round to nearest achievable weight (5 lb increments + optional 1.25, 2.5, or 3.75)
                const roundToAchievable = (weight) => {
                    const base = Math.floor(weight / 5) * 5;
                    const remainder = weight - base;

                    // Find closest achievable increment: 0, 1.25, 2.5, or 3.75
                    if (remainder < 0.625) return base;
                    else if (remainder < 1.875) return base + 1.25;
                    else if (remainder < 3.125) return base + 2.5;
                    else if (remainder < 4.375) return base + 3.75;
                    else return base + 5;
                };

                const warmup1 = roundToAchievable(totalWeight * 0.5);  // 50%
                const warmup2 = roundToAchievable(totalWeight * 0.75); // 75%

                return {
                    warmup1,
                    warmup2
                };
            };

            const renderExercise = (exercise) => {
                const previous = getPreviousWorkout(exercise.id);
                const isLogged = loggedExercises[exercise.id];
                const data = workoutData[exercise.id] || {};
                const showPlateauBuster = isPlateauBuster(exercise.id);
                const prWeightRecovery = getPRWeightRecovery(exercise.id);
                const failedPlateauBusterRetry = !prWeightRecovery ? getFailedPlateauBusterRetry(exercise.id) : null;
                const prAutoRegulation = !prWeightRecovery && !failedPlateauBusterRetry ? getPRAutoRegulation(exercise.id) : null; // Only show if not already showing plateau recovery or failed plateau retry
                const plateauBusterDecrement = showPlateauBuster && !prWeightRecovery ? getPlateauBusterDecrement(exercise.id) : null;

                if (exercise.type === 'standard') {
                    console.log('[renderExercise]', exercise.name, {
                        showPlateauBuster,
                        prWeightRecovery,
                        failedPlateauBusterRetry,
                        prAutoRegulation,
                        plateauBusterDecrement,
                        previous
                    });
                }

                // Get default weight for Week 1
                const defaultWeight = currentWeek === 1 && !previous ? WEEK_1_DEFAULTS[exercise.id] : null;

                /* ============================================
                   ASSAULT BIKE DISPLAY - COMMENTED OUT
                   To switch back: uncomment this block and comment out stairmaster below
                   Also update DEFAULT_DAY_2_EXERCISES to use assault-bike instead of stairmaster
                   ============================================ */
                /*
                if (exercise.type === 'assault-bike') {
                    const assaultBikePR = getAssaultBikePR();

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">
                                        {exercise.name}
                                    </div>
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.watts} watts
                                    </div>
                                )}
                            </div>
                            {assaultBikePR && (
                                <div style={{
                                    color: '#4CAF50',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    marginBottom: '8px',
                                    marginTop: '-4px'
                                }}>
                                    +25 watts
                                </div>
                            )}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Intensity</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="10/20"
                                        disabled
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Watts</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className="input-field"
                                        value={data.watts || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'watts', e.target.value)}
                                        placeholder={assaultBikePR ? assaultBikePR.watts : (previous?.watts || '')}
                                        disabled={isLogged}
                                        style={assaultBikePR ? {
                                            border: '2px solid #4CAF50'
                                        } : {}}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }
                */
                /* END ASSAULT BIKE DISPLAY */

                /* STAIRMASTER DISPLAY - To switch back to assault bike, comment out this block */
                if (exercise.type === 'stairmaster') {
                    // Generate time options from 5:00 to 20:00 in 15-second increments
                    const timeOptions = [];
                    for (let minutes = 5; minutes <= 20; minutes++) {
                        for (let seconds = 0; seconds < 60; seconds += 15) {
                            if (minutes === 20 && seconds > 0) break; // Stop at 20:00
                            timeOptions.push(formatSecondsToTime(minutes * 60 + seconds));
                        }
                    }

                    const stairmasterSuggestion = getStairmasterSuggestion(exercise.id);
                    const suggestedTime = stairmasterSuggestion?.time || '5:00';
                    const showSuggestion = !stairmasterSuggestion?.isFirstSession;

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div className="exercise-name">
                                    {exercise.name}
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: Level 10 - {previous.time}
                                    </div>
                                )}
                            </div>
                            {showSuggestion && (
                                <div style={{
                                    color: '#4CAF50',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    marginBottom: '8px',
                                    marginTop: '-4px'
                                }}>
                                    +15 seconds
                                </div>
                            )}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Level</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="Level 10"
                                        disabled
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Time</label>
                                    <select
                                        className="input-field"
                                        value={data.time || suggestedTime}
                                        onChange={(e) => handleInputChange(exercise.id, 'time', e.target.value)}
                                        disabled={isLogged}
                                        style={showSuggestion ? {
                                            border: '2px solid #4CAF50'
                                        } : {}}
                                    >
                                        {timeOptions.map(time => (
                                            <option key={time} value={time}>{time}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }
                /* END STAIRMASTER DISPLAY */

                if (exercise.type === 'bodyweight') {
                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div className="exercise-name">{exercise.name}</div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.reps} reps
                                    </div>
                                )}
                            </div>
                            {prWeightRecovery ? (
                                <div style={{
                                    color: '#4CAF50',
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    marginBottom: '12px',
                                    fontWeight: '600',
                                    fontSize: '14px',
                                    textAlign: 'center'
                                }}>
                                    Trial of Strength
                                </div>
                            ) : (showPlateauBuster && !failedPlateauBusterRetry) ? (
                                <div style={{
                                    color: '#ff9500',
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    marginBottom: '12px',
                                    fontWeight: '600',
                                    fontSize: '14px',
                                    textAlign: 'center'
                                }}>
                                    Plateau Buster - Hit 2 Sets
                                </div>
                            ) : null}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Weight</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="Body Weight"
                                        disabled
                                    />
                                </div>
                                <div className="input-group" style={{ position: 'relative' }}>
                                    {prWeightRecovery && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '-20px',
                                            left: '0',
                                            color: '#4CAF50',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            PR Reps to Beat
                                        </div>
                                    )}
                                    <label className="input-label">Reps</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className="input-field"
                                        value={data.reps || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                        placeholder={prWeightRecovery?.reps || previous?.reps || ''}
                                        disabled={isLogged}
                                        style={prWeightRecovery ? {
                                            border: '2px solid #4CAF50'
                                        } : {}}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                // Standard exercise
                const isPlateLoaded = PLATE_LOADED_EXERCISES[exercise.id];
                const isPinStack = PIN_STACK_EXERCISES[exercise.id];
                const hasWeightBreakdown = isPlateLoaded || isPinStack;
                const isBreakdownExpanded = expandedWeightBreakdown === exercise.id;

                return (
                    <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                        <div className="exercise-header">
                            <div>
                                <div className="exercise-name">
                                    {exercise.name}
                                </div>
                                {previous && (
                                    <div className="previous-data" style={{ marginTop: '4px' }}>
                                        Last: {previous.weight}lbs  {previous.reps}
                                    </div>
                                )}
                            </div>
                            {hasWeightBreakdown && (
                                <button
                                    onClick={() => setExpandedWeightBreakdown(isBreakdownExpanded ? null : exercise.id)}
                                    style={{
                                        padding: '6px 12px',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        backgroundColor: '#3a2a5a',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        whiteSpace: 'nowrap'
                                    }}
                                >
                                    {isBreakdownExpanded ? 'Hide' : 'Weight Breakdown'}
                                </button>
                            )}
                        </div>
                        {isBreakdownExpanded && (() => {
                            // Get current weight from input field (same logic as the input field's value)
                            const displayedWeight = data.weight !== undefined ? data.weight : (prWeightRecovery?.weight || failedPlateauBusterRetry?.weight || prAutoRegulation?.weight || plateauBusterDecrement?.weight || previous?.weight || defaultWeight || '');
                            const currentWeight = parseFloat(displayedWeight) || 0;

                            if (currentWeight === 0) return null;

                            // PIN-STACK EXERCISE
                            if (isPinStack) {
                                const warmups = calculatePinStackWarmups(currentWeight);

                                return (
                                    <div style={{
                                        backgroundColor: '#050510',
                                        padding: '12px',
                                        borderRadius: '8px',
                                        marginBottom: '12px',
                                        fontSize: '13px',
                                        fontFamily: 'monospace'
                                    }}>
                                        <div style={{ marginBottom: '8px' }}>
                                            <div style={{ fontWeight: '600' }}>
                                                Warmup Set #1 (~50%): {warmups.warmup1} lbs
                                            </div>
                                        </div>

                                        <div>
                                            <div style={{ fontWeight: '600' }}>
                                                Warmup Set #2 (~75%): {warmups.warmup2} lbs
                                            </div>
                                        </div>
                                    </div>
                                );
                            }

                            // PLATE-LOADED EXERCISE
                            const breakdown = calculatePlateBreakdown(currentWeight, exercise.id);

                            if (!breakdown) return null;

                            const renderPlates = (plates) => {
                                // Sort plates in descending order: 45s > 25s > 10s > 5s > 2.5s > 1.25s
                                const sortedPlates = Object.entries(plates).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
                                return sortedPlates.map(([weight, count]) => (
                                    <div key={weight} style={{ marginLeft: '12px' }}>
                                        {weight}s - {count}
                                    </div>
                                ));
                            };

                            // Calculate actual weight from plates
                            const getActualWeight = (plates) => {
                                return Object.entries(plates).reduce((total, [weight, count]) => {
                                    return total + (parseFloat(weight) * count);
                                }, 0);
                            };

                            const warmup1Actual = getActualWeight(breakdown.warmup1.plates);
                            const warmup2Actual = getActualWeight(breakdown.warmup2.plates);
                            const topSetActual = getActualWeight(breakdown.topSet.plates);

                            const warmup1Total = breakdown.isTwoSided ? warmup1Actual * 2 : warmup1Actual;
                            const warmup2Total = breakdown.isTwoSided ? warmup2Actual * 2 : warmup2Actual;
                            const topSetTotal = breakdown.isTwoSided ? topSetActual * 2 : topSetActual;

                            return (
                                <div style={{
                                    backgroundColor: '#050510',
                                    padding: '12px',
                                    borderRadius: '8px',
                                    marginBottom: '12px',
                                    fontSize: '13px',
                                    fontFamily: 'monospace'
                                }}>
                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                            Warmup Set #1 ({warmup1Total} lbs - ~50%):
                                        </div>
                                        {breakdown.isTwoSided && (
                                            <div style={{ marginLeft: '12px', fontStyle: 'italic', color: '#666' }}>
                                                Per side: {warmup1Actual} lbs
                                            </div>
                                        )}
                                        {renderPlates(breakdown.warmup1.plates)}
                                    </div>

                                    <div style={{ marginBottom: '12px' }}>
                                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                            Warmup Set #2 ({warmup2Total} lbs - ~75%):
                                        </div>
                                        {breakdown.isTwoSided && (
                                            <div style={{ marginLeft: '12px', fontStyle: 'italic', color: '#666' }}>
                                                Per side: {warmup2Actual} lbs
                                            </div>
                                        )}
                                        {renderPlates(breakdown.warmup2.plates)}
                                    </div>

                                    <div>
                                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                            Top Set ({topSetTotal} lbs):
                                        </div>
                                        {breakdown.isTwoSided && (
                                            <div style={{ marginLeft: '12px', fontStyle: 'italic', color: '#666' }}>
                                                Per side: {topSetActual} lbs
                                            </div>
                                        )}
                                        {renderPlates(breakdown.topSet.plates)}
                                    </div>
                                </div>
                            );
                        })()}
                        {prWeightRecovery ? (
                            <div style={{
                                color: '#4CAF50',
                                padding: '8px 12px',
                                borderRadius: '6px',
                                marginBottom: '12px',
                                fontWeight: '600',
                                fontSize: '14px',
                                textAlign: 'center'
                            }}>
                                Trial of Strength
                            </div>
                        ) : (showPlateauBuster && !failedPlateauBusterRetry) ? (
                            <div style={{
                                color: '#ff9500',
                                padding: '8px 12px',
                                borderRadius: '6px',
                                marginBottom: '12px',
                                fontWeight: '600',
                                fontSize: '14px',
                                textAlign: 'center'
                            }}>
                                Plateau Buster - Hit 2 Sets
                            </div>
                        ) : null}
                        {prWeightRecovery && (
                            <div style={{
                                color: '#4CAF50',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '-4px'
                            }}>
                                PR Weight Detected
                            </div>
                        )}
                        {prAutoRegulation && !prWeightRecovery && (
                            <div style={{
                                color: '#4CAF50',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '4px'
                            }}>
                                +{prAutoRegulation.increment}lbs
                            </div>
                        )}
                        {plateauBusterDecrement && !prWeightRecovery && !prAutoRegulation && !failedPlateauBusterRetry && (
                            <div style={{
                                color: '#ff9500',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '4px'
                            }}>
                                -{plateauBusterDecrement.increment}lbs
                            </div>
                        )}
                        {failedPlateauBusterRetry && !prWeightRecovery && !prAutoRegulation && (
                                <div style={{
                                    color: '#ff9500',
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    marginBottom: '12px',
                                    fontWeight: '600',
                                    fontSize: '14px',
                                    textAlign: 'center'
                                }}>
                                Plateau Buster - Hit 1 Set of {failedPlateauBusterRetry.targetReps} Reps
                                </div>
                        )}
                        <div className="input-row">
                            <div className="input-group">
                                <label className="input-label">Weight (lbs)</label>
                                <input
                                    type="number"
                                    inputMode="decimal"
                                    className="input-field"
                                    value={data.weight !== undefined ? data.weight : (prWeightRecovery?.weight || failedPlateauBusterRetry?.weight || prAutoRegulation?.weight || plateauBusterDecrement?.weight || previous?.weight || '')}
                                    onChange={(e) => handleInputChange(exercise.id, 'weight', e.target.value)}
                                    placeholder={previous?.weight || ''}
                                    disabled={isLogged}
                                    style={prWeightRecovery || prAutoRegulation ? {
                                        border: '2px solid #4CAF50'
                                    } : (showPlateauBuster || failedPlateauBusterRetry) ? {
                                        border: '2px solid #ff9500'
                                    } : {}}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Reps</label>
                                <input
                                    type="number"
                                    inputMode="numeric"
                                    className="input-field"
                                    value={data.reps || ''}
                                    onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                    placeholder={prWeightRecovery?.reps || (failedPlateauBusterRetry?.targetReps) || (prAutoRegulation ? '6' : (plateauBusterDecrement ? '8' : (showPlateauBuster && previous?.reps ? String(parseInt(previous.reps)) : (previous?.reps ? String(parseInt(previous.reps) + 1) : ''))))}
                                    disabled={isLogged}
                                />
                            </div>
                        </div>
                        <button
                            className={`log-btn ${isLogged ? 'logged' : ''}`}
                            onClick={() => logExercise(exercise.id)}
                            disabled={isLogged}
                        >
                            {isLogged ? ' Logged' : 'LOG'}
                        </button>
                    </div>
                );
            };

            return (
                <>
                    <div className="day-selector">
                        <button
                            className={`day-btn ${currentDay === 1 ? 'active' : ''}`}
                            onClick={() => setCurrentDay(1)}
                        >
                            Anterior
                        </button>
                        <button
                            className={`day-btn ${currentDay === 2 ? 'active' : ''}`}
                            onClick={() => setCurrentDay(2)}
                        >
                            Posterior
                        </button>
                    </div>

                    {currentDay === 1 ? (
                        <>
                            <div className="section-title">Anterior</div>
                            {anteriorExercises.map(renderExercise)}

                            <div className="section-title">Cardio</div>
                            {cardioExercises.map(renderExercise)}
                        </>
                    ) : (
                        <>
                            <div className="section-title">Posterior</div>
                            {posteriorExercises.map(renderExercise)}

                            <div className="section-title">Cardio</div>
                            {cardioExercises.map(renderExercise)}
                        </>
                    )}

                    <button className="save-btn" onClick={completeDay}>
                        Submit Day and View Breakdown
                    </button>

                </>
            );
        }


        function WeeklyView({ workoutHistory, viewingWeek, setViewingWeek, currentWeek, day1Exercises, day2Exercises, onEditWorkout }) {
            const weekWorkouts = workoutHistory
                .filter(w => w.week === viewingWeek)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest to oldest

            return (
                <>
                    <div className="week-nav">
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek - 1)}
                            disabled={viewingWeek <= 1}
                        >
                             Prev
                        </button>
                        <div className="week-title">
                            Week {viewingWeek}
                            {viewingWeek === currentWeek && ' (Current)'}
                        </div>
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek + 1)}
                            disabled={viewingWeek >= currentWeek}
                        >
                            Next 
                        </button>
                    </div>

                    {weekWorkouts.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"></div>
                            <div>No workouts in Week {viewingWeek}</div>
                        </div>
                    ) : (
                        <>
                            {weekWorkouts.map((workout, idx) => {
                                const date = new Date(workout.date);
                                const formattedDate = date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                const formattedTime = date.toLocaleTimeString('en-US', {
                                    hour: 'numeric',
                                    minute: '2-digit'
                                });

                                // Get all exercises for this day
                                const allExercises = workout.day === 1 ? day1Exercises : day2Exercises;
                                const completedIds = new Set(workout.exercises.map(e => e.id));

                                // Calculate sequential day number - count down from total
                                const dayNumber = weekWorkouts.length - idx;

                                return (
                                    <div key={idx} className="history-item">
                                        <div className="history-date" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <span>Day {dayNumber} - {formattedDate}</span>
                                            <button
                                                onClick={() => onEditWorkout(workout)}
                                                style={{
                                                    background: 'none',
                                                    border: 'none',
                                                    color: '#6a5a8a',
                                                    cursor: 'pointer',
                                                    fontSize: '18px',
                                                    padding: '4px 8px'
                                                }}
                                            >
                                                
                                            </button>
                                        </div>
                                        {allExercises.map((expectedExercise) => {
                                            const completedExercise = workout.exercises.find(e => e.id === expectedExercise.id);
                                            return (
                                                <div key={expectedExercise.id} className="history-exercise">
                                                    <div className="history-exercise-name">{expectedExercise.name}</div>
                                                    <div className="history-exercise-data">
                                                        {completedExercise ? (
                                                            completedExercise.type === 'assault-bike'
                                                                ? (completedExercise.watts ? `${completedExercise.watts} watts` : <span style={{ color: '#555' }}>NA</span>)
                                                                : completedExercise.type === 'stairmaster'
                                                                ? (completedExercise.time ? `${completedExercise.time} / Level 10` : <span style={{ color: '#555' }}>NA</span>)
                                                                : (completedExercise.weight && completedExercise.reps
                                                                    ? `${completedExercise.weight}${completedExercise.weight === 'Body Weight' ? '' : 'lbs'}  ${completedExercise.reps}`
                                                                    : <span style={{ color: '#555' }}>NA</span>)
                                                        ) : (
                                                            <span style={{ color: '#555' }}>NA</span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}
                        </>
                    )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
