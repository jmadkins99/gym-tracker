<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gym Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #050510;
            color: #b8b8d0;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 100%;
            min-height: 100vh;
        }

        .header {
            background: #0d0d1a;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #3a2a5a;
            box-shadow: 0 4px 20px rgba(58, 42, 90, 0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 24px;
        }

        .week-indicator {
            font-size: 14px;
            color: #6a5a8a;
            margin-bottom: 15px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: #6a5a8a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        .content {
            padding: 20px;
        }

        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-btn {
            flex: 1;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-btn.active {
            background: #3a2a5a;
            border-color: #4a3a6a;
            color: #b8b8d0;
        }

        .section-title {
            font-size: 14px;
            color: #6a5a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }

        .exercise-card {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .exercise-card.logged {
            border-color: #3a2a5a;
            background: #12121f;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 600;
        }

        .previous-data {
            font-size: 12px;
            color: #888;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
        }

        .input-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            display: block;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 16px;
            -webkit-appearance: none;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3a2a5a;
        }

        .input-field:disabled {
            opacity: 0.5;
        }

        .log-btn {
            width: 100%;
            padding: 12px;
            background: #3a2a5a;
            border: none;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .log-btn:active {
            transform: scale(0.98);
        }

        .log-btn.logged {
            background: #1a1a2a;
            color: #6a5a8a;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: #2a1a3a;
            border: none;
            border-radius: 12px;
            color: #b8b8d0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            background: #1a1a2a;
            color: #666;
        }

        .na-btn {
            width: 100%;
            padding: 12px;
            background: #3a1a1a;
            border: 2px solid #6a2a2a;
            border-radius: 8px;
            color: #d08888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .na-btn:hover {
            background: #4a2222;
            border-color: #8a3a3a;
        }

        .na-btn:active {
            transform: scale(0.98);
        }

        .week-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-nav-btn {
            padding: 8px 16px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .week-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .week-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        .history-item {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #1a1a2a;
        }

        .history-date {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .history-exercise {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2a;
            font-size: 14px;
        }

        .history-exercise:last-child {
            border-bottom: none;
        }

        .history-exercise-name {
            color: #6a5a8a;
        }

        .history-exercise-data {
            font-weight: 600;
        }

        .chart-container {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #1a1a2a;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .success-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #3a2a5a;
            color: #b8b8d0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .exercise-select {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            color: #b8b8d0;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .exercise-select option {
            background: #0d0d1a;
            color: #b8b8d0;
        }

        canvas {
            max-height: 250px;
        }



        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 5, 16, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: #0d0d1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid #2a2a3a;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: #1a1a2a;
            border: 1px solid #2a2a3a;
            color: #8a8aa0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn.primary {
            background: #3a2a5a;
            border-color: #3a2a5a;
            color: #b8b8d0;
        }

        .modal-btn.danger {
            background: #3a1a2a;
            border-color: #3a1a2a;
            color: #b8b8d0;
        }

        .file-input {
            display: none;
        }

        .backup-reminder {
            background: #ff9500;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Week 1 default weights
        const WEEK_1_DEFAULTS = {
            'chest-flies': '165',
            'incline-chest-press': '110',
            'flat-chest-press': '135',
            'shoulder-press': '126.25',
            'preacher-curls': '56.25',
            'tricep-pushdown': '36.25',
            'lateral-raises': '27.5',
            'overhead-tricep': '27.5',
            'upper-back-row': '190',
            'kelso-shrugs': '190',
            'frontal-pulldowns': '180',
            'hammer-row': '117.5',
            'leg-extensions': '240',
            'leg-curls': '150',
            'hip-adduction': '120',
            'calf-raise': '180',
            'cable-wrist-curls': '87.5',
            'ab-crunch': '140',
            'hanging-leg-raises': 'Body Weight'
        };

        // PR Auto-Regulation: Weight increments when you hit 8+ reps
        // Edit these values to customize weight progression for each exercise
        const PR_WEIGHT_INCREMENTS = {
            'chest-flies': 1.25,
            'incline-chest-press': 2.5,
            'flat-chest-press': 2.5,
            'shoulder-press': 2.5,
            'preacher-curls': 1.25,
            'tricep-pushdown': 1.25,
            'lateral-raises': 1.25,
            'overhead-tricep': 1.25,
            'frontal-pulldowns': 1.25,
            'upper-back-row': 2.5,
            'kelso-shrugs': 2.5,
            'hammer-row': 2.5,
            'leg-extensions': 1.25,
            'leg-curls': 1.25,
            'hip-adduction': 1.25,
            'calf-raise': 1.25,
            'cable-wrist-curls': 1.25,
            'ab-crunch': 1.25
        };

        const DEFAULT_DAY_1_EXERCISES = [
            // Upper
            { id: 'chest-flies', name: 'Chest Flies', category: 'Upper', type: 'standard', order: 0 },
            { id: 'incline-chest-press', name: 'Incline Chest Press Machine', category: 'Upper', type: 'standard', order: 1 },
            { id: 'flat-chest-press', name: 'Flat Chest Press Machine', category: 'Upper', type: 'standard', order: 2 },
            { id: 'shoulder-press', name: 'Shoulder Press Machine', category: 'Upper', type: 'standard', order: 3 },
            { id: 'preacher-curls', name: 'Preacher Curls', category: 'Upper', type: 'standard', order: 4 },
            { id: 'tricep-pushdown', name: 'Cuffed Tricep Pushdown', category: 'Upper', type: 'standard', order: 5 },
            { id: 'lateral-raises', name: 'Cuffed Cable Lateral Raises', category: 'Upper', type: 'standard', order: 6 },
            { id: 'overhead-tricep', name: 'Cuffed Overhead Tricep Extension', category: 'Upper', type: 'standard', order: 7 },
            { id: 'upper-back-row', name: 'Upper Back Row Machine', category: 'Upper', type: 'standard', order: 8 },
            { id: 'kelso-shrugs', name: 'Machine Kelso Shrugs', category: 'Upper', type: 'standard', order: 9 },
            { id: 'frontal-pulldowns', name: 'Frontal Plane Pulldowns', category: 'Upper', type: 'standard', order: 10 },
            { id: 'hammer-row', name: 'Seated Row Machine', category: 'Upper', type: 'standard', order: 11 },
            // Lower
            { id: 'leg-extensions', name: 'Leg Extensions', category: 'Lower', type: 'standard', order: 12 },
            { id: 'leg-curls', name: 'Prone Leg Curls', category: 'Lower', type: 'standard', order: 13 },
            { id: 'hip-adduction', name: 'Hip Adduction Machine', category: 'Lower', type: 'standard', order: 14 },
            { id: 'calf-raise', name: 'Seated Calf Raise Machine', category: 'Lower', type: 'standard', order: 15 },
        ];

        const DEFAULT_DAY_2_EXERCISES = [
            { id: 'cable-wrist-curls', name: 'Cable Wrist Curls', category: 'Accessories', type: 'standard', order: 0 },
            { id: 'ab-crunch', name: 'Ab Crunch Machine', category: 'Accessories', type: 'standard', order: 1 },
            { id: 'hanging-leg-raises', name: 'Hanging Leg Raises', category: 'Accessories', type: 'bodyweight', order: 2 },
            { id: 'stairmaster', name: 'StairMaster', category: 'Cardio', type: 'stairmaster', order: 3 },
            { id: 'assault-bike', name: 'Assault Bike', category: 'Cardio', type: 'assault-bike', order: 4 },
        ];

        // Calculate which day it should be based on the date
        function getTodayDay() {
            // Reference: Dec 16, 2025 is Day 1 (Full Body)
            const today = new Date();
            const referenceDate = new Date(2025, 11, 16); // Month is 0-indexed, so 11 = December

            // Reset to midnight
            today.setHours(0, 0, 0, 0);
            referenceDate.setHours(0, 0, 0, 0);

            const diffTime = today - referenceDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // Alternates each day: Dec 16 = Day 1 (Full Body), Dec 17 = Day 2 (Accessory), Dec 18 = Day 1, etc.
            return (diffDays % 2 === 0) ? 1 : 2;
        }

        // ISO week number (weeks start on Monday)
        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Calculate current week number (ISO weeks start on Monday)
        function getCurrentWeek() {
            return getISOWeek(new Date());
        }

        // Get week number for a specific date
        function getWeekNumber(date) {
            return getISOWeek(date);
        }

        // Parse MM:SS to total seconds
        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1]) || 0;
            return minutes * 60 + seconds;
        }

        // Format seconds to MM:SS
        function formatSecondsToTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Namespace localStorage based on app path to prevent conflicts between gym-tracker and public-gym-app
        const APP_NAMESPACE = (() => {
            const path = window.location.pathname;
            if (path.includes('/gym-tracker/')) return 'gym-tracker:';
            if (path.includes('/public-gym-app/')) return 'public-gym-app:';
            // Fallback for local development or other paths
            return 'gym-local:';
        })();

        // Helper functions for namespaced localStorage
        const storage = {
            getItem: (key) => localStorage.getItem(APP_NAMESPACE + key),
            setItem: (key, value) => localStorage.setItem(APP_NAMESPACE + key, value),
            removeItem: (key) => localStorage.removeItem(APP_NAMESPACE + key),
        };

        // Migrate existing data to namespaced keys (one-time migration for existing users)
        function migrateToNamespacedStorage() {
            const keysToMigrate = ['gymWorkoutHistory', 'gymExerciseConfig', 'lastBackupReminder'];

            keysToMigrate.forEach(key => {
                // Check if data exists in the old location (without namespace)
                const oldData = localStorage.getItem(key);
                // Check if data already exists in the new location (with namespace)
                const newData = storage.getItem(key);

                // Only migrate if old data exists and new location is empty
                if (oldData && !newData) {
                    storage.setItem(key, oldData);
                    // Optionally remove the old data to clean up
                    // Commenting this out to be safe - users can manually clear old data later
                    // localStorage.removeItem(key);
                }
            });
        }

        function App() {
            const [currentView, setCurrentView] = useState('workout');
            const [currentDay, setCurrentDay] = useState(getTodayDay());
            const [workoutData, setWorkoutData] = useState({});
            const [loggedExercises, setLoggedExercises] = useState({});
            const [workoutHistory, setWorkoutHistory] = useState([]);
            const [showSuccess, setShowSuccess] = useState(false);
            const [successMessage, setSuccessMessage] = useState('');
            const [day1Exercises, setDay1Exercises] = useState(DEFAULT_DAY_1_EXERCISES);
            const [day2Exercises, setDay2Exercises] = useState(DEFAULT_DAY_2_EXERCISES);
            const [selectedExercise, setSelectedExercise] = useState(DEFAULT_DAY_1_EXERCISES[0].id);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackupReminder, setShowBackupReminder] = useState(false);
            const [showDayBreakdown, setShowDayBreakdown] = useState(false);
            const [showEditWorkout, setShowEditWorkout] = useState(false);
            const [editingWorkout, setEditingWorkout] = useState(null);
            const [viewingWeek, setViewingWeek] = useState(getCurrentWeek());
            const currentWeek = getCurrentWeek();

            useEffect(() => {
                // Migrate existing data to namespaced storage (one-time for existing users)
                migrateToNamespacedStorage();

                // Load workout history
                const saved = storage.getItem('gymWorkoutHistory');
                if (saved) {
                    const history = JSON.parse(saved);
                    setWorkoutHistory(history);
                }

                // Load custom exercise configurations
                const savedExercises = storage.getItem('gymExerciseConfig');
                if (savedExercises) {
                    const config = JSON.parse(savedExercises);
                    if (config.day1) {
                        setDay1Exercises(config.day1.sort((a, b) => a.order - b.order));
                    }
                    if (config.day2) {
                        setDay2Exercises(config.day2.sort((a, b) => a.order - b.order));
                    }
                }

                // Check last backup reminder
                const lastReminder = storage.getItem('lastBackupReminder');
                const now = new Date().getTime();
                const oneMonth = 30 * 24 * 60 * 60 * 1000;

                if (!lastReminder || (now - parseInt(lastReminder)) > oneMonth) {
                    setShowBackupReminder(true);
                }
            }, []);

            // Restore logged state and workout data from today's workout
            useEffect(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayWorkout = workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });

                if (todayWorkout && !todayWorkout.submitted) {
                    // Only restore state if workout hasn't been submitted yet
                    const newLoggedExercises = {};
                    const newWorkoutData = {};

                    todayWorkout.exercises.forEach(exercise => {
                        // Check if exercise has actual data (not just defaults or empty values)
                        let hasData = false;
                        if (exercise.type === 'assault-bike') {
                            hasData = exercise.rounds && exercise.rounds !== '' && exercise.rounds !== 'NA';
                        } else if (exercise.type === 'stairmaster') {
                            hasData = exercise.time && exercise.time !== '' && exercise.time !== 'NA';
                        } else if (exercise.type === 'bodyweight') {
                            hasData = exercise.reps && exercise.reps !== '' && exercise.reps !== 'NA';
                        } else {
                            hasData = (exercise.weight && exercise.weight !== '' && exercise.weight !== 'NA') ||
                                     (exercise.reps && exercise.reps !== '' && exercise.reps !== 'NA');
                        }

                        if (hasData) {
                            newLoggedExercises[exercise.id] = true;

                            if (exercise.type === 'assault-bike') {
                                newWorkoutData[exercise.id] = { rounds: exercise.rounds };
                            } else if (exercise.type === 'stairmaster') {
                                newWorkoutData[exercise.id] = { time: exercise.time, level: exercise.level || 'Level 7' };
                            } else if (exercise.type === 'bodyweight') {
                                newWorkoutData[exercise.id] = { reps: exercise.reps };
                            } else {
                                newWorkoutData[exercise.id] = {
                                    weight: exercise.weight,
                                    reps: exercise.reps
                                };
                            }
                        }
                    });

                    setLoggedExercises(newLoggedExercises);
                    setWorkoutData(newWorkoutData);
                } else {
                    // Clear logged state if switching to a day with no workout or if workout is submitted
                    setLoggedExercises({});
                    setWorkoutData({});
                }
            }, [workoutHistory, currentDay]);

            const getCurrentExercises = () => {
                return currentDay === 1 ? day1Exercises : day2Exercises;
            };

            const getTodayWorkout = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return workoutHistory.find(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    return isSameDay && isSameWorkoutDay;
                });
            };

            const isWorkoutSubmitted = () => {
                const todayWorkout = getTodayWorkout();
                return todayWorkout && todayWorkout.submitted;
            };

            const saveExerciseConfig = () => {
                const config = {
                    day1: day1Exercises,
                    day2: day2Exercises
                };
                storage.setItem('gymExerciseConfig', JSON.stringify(config));
            };

            const updateExerciseName = (day, exerciseId, newName) => {
                if (day === 1) {
                    setDay1Exercises(prev => {
                        const updated = prev.map(ex =>
                            ex.id === exerciseId ? { ...ex, name: newName } : ex
                        );
                        // Save immediately
                        const config = { day1: updated, day2: day2Exercises };
                        storage.setItem('gymExerciseConfig', JSON.stringify(config));
                        return updated;
                    });
                } else {
                    setDay2Exercises(prev => {
                        const updated = prev.map(ex =>
                            ex.id === exerciseId ? { ...ex, name: newName } : ex
                        );
                        // Save immediately
                        const config = { day1: day1Exercises, day2: updated };
                        storage.setItem('gymExerciseConfig', JSON.stringify(config));
                        return updated;
                    });
                }
            };

            const moveExercise = (day, exerciseId, direction) => {
                const exercises = day === 1 ? day1Exercises : day2Exercises;
                const currentIndex = exercises.findIndex(ex => ex.id === exerciseId);

                if (direction === 'up' && currentIndex === 0) return;
                if (direction === 'down' && currentIndex === exercises.length - 1) return;

                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                const reordered = [...exercises];
                [reordered[currentIndex], reordered[newIndex]] = [reordered[newIndex], reordered[currentIndex]];

                // Update order values
                const updated = reordered.map((ex, idx) => ({ ...ex, order: idx }));

                if (day === 1) {
                    setDay1Exercises(updated);
                    const config = { day1: updated, day2: day2Exercises };
                    storage.setItem('gymExerciseConfig', JSON.stringify(config));
                } else {
                    setDay2Exercises(updated);
                    const config = { day1: day1Exercises, day2: updated };
                    storage.setItem('gymExerciseConfig', JSON.stringify(config));
                }
            };

            const getPreviousWorkout = (exerciseId) => {
                if (workoutHistory.length === 0) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find up to 3 most recent workouts with this exercise (excluding today's unsubmitted workout)
                const candidates = [];
                for (let workout of workoutHistory) {
                    if (candidates.length >= 3) break; // Stop after finding 3 candidates

                    const workoutDate = new Date(workout.date);
                    workoutDate.setHours(0, 0, 0, 0);

                    // Skip today's workout only if it's not submitted yet
                    if (workoutDate.getTime() === today.getTime() && workout.day === currentDay && !workout.submitted) {
                        continue;
                    }

                    const exercise = workout.exercises.find(e => e.id === exerciseId);
                    if (exercise) {
                        candidates.push(exercise);
                    }
                }

                // Return first candidate that doesn't have "NA" reps
                for (let candidate of candidates) {
                    if (candidate.reps && candidate.reps !== 'NA') {
                        return candidate;
                    }
                }

                // If all candidates have NA reps (or no valid candidates), return the most recent one
                return candidates.length > 0 ? candidates[0] : null;
            };

            const handleInputChange = (exerciseId, field, value) => {
                setWorkoutData(prev => ({
                    ...prev,
                    [exerciseId]: {
                        ...prev[exerciseId],
                        [field]: value
                    }
                }));
            };

            const logExercise = (exerciseId) => {
                const exercise = getCurrentExercises().find(e => e.id === exerciseId);
                let data = workoutData[exerciseId] || {};

                // Capture auto-filled weight if user didn't manually enter it
                if (exercise.type === 'standard' && !data.weight && data.reps) {
                    console.log('[logExercise] Trying to capture auto-filled weight for:', exercise.name);
                    console.log('[logExercise] Current data:', data);
                    // Find the weight input field for this exercise and read its displayed value
                    const exerciseCard = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
                    console.log('[logExercise] Found exercise card:', exerciseCard);
                    if (exerciseCard) {
                        // Find the weight input (it's the first number input with inputmode="decimal")
                        const weightInput = exerciseCard.querySelector('input[type="number"][inputmode="decimal"]');
                        console.log('[logExercise] Found weight input:', weightInput);
                        console.log('[logExercise] Weight input value:', weightInput?.value);
                        if (weightInput && weightInput.value) {
                            data = { ...data, weight: weightInput.value };
                            console.log('[logExercise] Captured weight from DOM:', weightInput.value);
                        }
                    }
                }
                console.log('[logExercise] Final data to save:', data);

                if (!data || Object.keys(data).length === 0) return;

                // Validate data based on exercise type
                if (exercise.type === 'assault-bike' && !data.rounds) return;
                if (exercise.type === 'stairmaster' && !data.time) return;
                if (exercise.type === 'bodyweight' && !data.reps) return;
                if (exercise.type === 'standard' && !data.weight && !data.reps) return;

                let finalData = { ...data };
                const timestamp = new Date().toISOString();
                finalData.timestamp = timestamp;

                // Find if there's already a workout for today (that hasn't been submitted)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayWeek = getWeekNumber(today);

                let existingWorkoutIndex = workoutHistory.findIndex(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    const isNotSubmitted = !w.submitted;
                    return isSameDay && isSameWorkoutDay && isNotSubmitted;
                });

                // Create exercise object to save
                let exerciseToSave;
                if (exercise.type === 'assault-bike') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        intensity: '30/30',
                        rounds: finalData.rounds || ''
                    };
                } else if (exercise.type === 'stairmaster') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        level: finalData.level || 'Level 7',
                        time: finalData.time || ''
                    };
                } else if (exercise.type === 'bodyweight') {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: 'Body Weight',
                        reps: finalData.reps || ''
                    };
                } else {
                    exerciseToSave = {
                        id: exercise.id,
                        name: exercise.name,
                        category: exercise.category,
                        type: exercise.type,
                        weight: finalData.weight || '',
                        reps: finalData.reps || ''
                    };
                }

                let updatedHistory;
                if (existingWorkoutIndex !== -1) {
                    // Update existing workout
                    updatedHistory = [...workoutHistory];
                    const workout = updatedHistory[existingWorkoutIndex];
                    const exerciseIndex = workout.exercises.findIndex(e => e.id === exerciseId);

                    if (exerciseIndex !== -1) {
                        workout.exercises[exerciseIndex] = exerciseToSave;
                    } else {
                        workout.exercises.push(exerciseToSave);
                    }

                    workout.date = timestamp; // Update to latest timestamp
                } else {
                    // Create new workout with all exercises initialized to NA
                    const allExercises = getCurrentExercises().map(ex => {
                        if (ex.id === exerciseId) {
                            return exerciseToSave;
                        } else {
                            // Initialize as NA
                            if (ex.type === 'assault-bike') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    intensity: '30/30',
                                    rounds: ''
                                };
                            } else if (ex.type === 'stairmaster') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    level: 'Level 7',
                                    time: ''
                                };
                            } else if (ex.type === 'bodyweight') {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: 'Body Weight',
                                    reps: ''
                                };
                            } else {
                                return {
                                    id: ex.id,
                                    name: ex.name,
                                    category: ex.category,
                                    type: ex.type,
                                    weight: '',
                                    reps: ''
                                };
                            }
                        }
                    });

                    const newWorkout = {
                        date: timestamp,
                        day: currentDay,
                        week: todayWeek,
                        exercises: allExercises,
                        submitted: false,
                        plateauBusters: []
                    };

                    updatedHistory = [newWorkout, ...workoutHistory];
                }

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                setLoggedExercises(prev => ({
                    ...prev,
                    [exerciseId]: true
                }));

                setSuccessMessage('Exercise logged!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const completeDay = () => {
                // Find today's workout
                const todayWorkout = getTodayWorkout();

                if (!todayWorkout) {
                    alert('Please log at least one exercise first!');
                    return;
                }

                // Detect exercises with less than 6 reps for plateau busting next week
                const plateauBusters = [];
                console.log('[completeDay] Checking for plateau busters in:', todayWorkout);
                todayWorkout.exercises.forEach(exercise => {
                    // Only check standard and bodyweight exercises (those with reps)
                    if ((exercise.type === 'standard' || exercise.type === 'bodyweight') && exercise.reps) {
                        const reps = parseInt(exercise.reps);
                        console.log('[completeDay] Exercise:', exercise.name, 'Reps:', reps);
                        if (!isNaN(reps) && reps < 6) {
                            console.log('[completeDay] PLATEAU BUSTER detected for:', exercise.name);
                            plateauBusters.push(exercise.id);
                        }
                    }
                });
                console.log('[completeDay] Total plateau busters:', plateauBusters);

                // Mark workout as submitted (immutable) and add plateau busters
                const updatedHistory = workoutHistory.map(w => {
                    if (w === todayWorkout) {
                        return { ...w, submitted: true, plateauBusters };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                // Automatically backup to Downloads folder
                autoBackup();

                // Reset all log states so exercises act like a fresh day
                setLoggedExercises({});
                setWorkoutData({});

                setShowDayBreakdown(true);
            };

            const markDayAsNA = () => {
                if (!confirm('Are you sure you want to mark this day as NA?')) {
                    return;
                }

                const timestamp = new Date().toISOString();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayWeek = getWeekNumber(today);

                // Get all exercises for the current day
                const currentDayExercises = getCurrentExercises();

                // Create NA entries for all exercises based on their type
                const naExercises = currentDayExercises.map(ex => {
                    if (ex.type === 'assault-bike') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            intensity: '30/30',
                            rounds: 'NA'
                        };
                    } else if (ex.type === 'stairmaster') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            level: 'Level 7',
                            time: 'NA'
                        };
                    } else if (ex.type === 'bodyweight') {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            weight: 'Body Weight',
                            reps: 'NA'
                        };
                    } else {
                        return {
                            id: ex.id,
                            name: ex.name,
                            category: ex.category,
                            type: ex.type,
                            weight: 'NA',
                            reps: 'NA'
                        };
                    }
                });

                // Find if there's already a workout for today with the same day number (that hasn't been submitted)
                let existingWorkoutIndex = workoutHistory.findIndex(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    const isSameDay = workoutDate.getTime() === today.getTime();
                    const isSameWorkoutDay = w.day === currentDay;
                    const isNotSubmitted = !w.submitted;
                    return isSameDay && isSameWorkoutDay && isNotSubmitted;
                });

                let updatedHistory;
                if (existingWorkoutIndex !== -1) {
                    // Update existing workout with NA values and mark as submitted
                    updatedHistory = [...workoutHistory];
                    updatedHistory[existingWorkoutIndex] = {
                        ...updatedHistory[existingWorkoutIndex],
                        exercises: naExercises,
                        date: timestamp,
                        submitted: true,
                        plateauBusters: []
                    };
                } else {
                    // Create new workout and mark as submitted
                    const newWorkout = {
                        date: timestamp,
                        day: currentDay,
                        week: todayWeek,
                        exercises: naExercises,
                        submitted: true,
                        plateauBusters: []
                    };
                    updatedHistory = [newWorkout, ...workoutHistory];
                }

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));

                // Automatically backup to Downloads folder
                autoBackup();

                // Reset all log states so exercises act like a fresh day
                setLoggedExercises({});
                setWorkoutData({});

                // Show the breakdown modal
                setShowDayBreakdown(true);
            };

            const updateWorkout = (workoutDate, updatedExercises) => {
                const updatedHistory = workoutHistory.map(w => {
                    if (w.date === workoutDate) {
                        return { ...w, exercises: updatedExercises };
                    }
                    return w;
                });

                setWorkoutHistory(updatedHistory);
                storage.setItem('gymWorkoutHistory', JSON.stringify(updatedHistory));
                setSuccessMessage('Workout updated!');
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 2000);
            };

            const exportData = () => {
                const exportObj = {
                    workoutHistory,
                    exerciseConfig: {
                        day1: day1Exercises,
                        day2: day2Exercises
                    },
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const autoBackup = () => {
                const exportObj = {
                    workoutHistory,
                    exerciseConfig: {
                        day1: day1Exercises,
                        day2: day2Exercises
                    },
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `gym-tracker-AUTO-BACKUP-${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);

                        // Handle old format (just workout history array) or new format (object with configs)
                        if (Array.isArray(imported)) {
                            // Old format
                            setWorkoutHistory(imported);
                            storage.setItem('gymWorkoutHistory', JSON.stringify(imported));
                        } else {
                            // New format
                            if (imported.workoutHistory) {
                                setWorkoutHistory(imported.workoutHistory);
                                storage.setItem('gymWorkoutHistory', JSON.stringify(imported.workoutHistory));
                            }
                            if (imported.exerciseConfig) {
                                if (imported.exerciseConfig.day1) {
                                    setDay1Exercises(imported.exerciseConfig.day1.sort((a, b) => a.order - b.order));
                                }
                                if (imported.exerciseConfig.day2) {
                                    setDay2Exercises(imported.exerciseConfig.day2.sort((a, b) => a.order - b.order));
                                }
                                storage.setItem('gymExerciseConfig', JSON.stringify(imported.exerciseConfig));
                            }
                        }

                        setSuccessMessage('Data imported successfully!');
                        setShowSuccess(true);
                        setTimeout(() => setShowSuccess(false), 3000);
                        setShowSettings(false);
                    } catch (error) {
                        alert('Invalid backup file');
                    }
                };
                reader.readAsText(file);
            };

            const resetData = () => {
                if (confirm('ARE YOU VERY SURE? This will delete ALL your workout data AND exercise customizations permanently. This cannot be undone!')) {
                    if (confirm('FINAL WARNING: All your progress and custom exercise names/order will be lost forever. Continue?')) {
                        storage.removeItem('gymWorkoutHistory');
                        storage.removeItem('gymExerciseConfig');
                        storage.removeItem('lastBackupReminder');
                        setWorkoutHistory([]);
                        setWorkoutData({});
                        setLoggedExercises({});
                        setDay1Exercises(DEFAULT_DAY_1_EXERCISES);
                        setDay2Exercises(DEFAULT_DAY_2_EXERCISES);
                        setShowSettings(false);
                        setSuccessMessage('All data has been reset');
                        setShowSuccess(true);
                        setTimeout(() => setShowSuccess(false), 3000);
                    }
                }
            };

            const dismissBackupReminder = () => {
                storage.setItem('lastBackupReminder', new Date().getTime().toString());
                setShowBackupReminder(false);
            };

            return (
                <div className="app">
                    {showSuccess && <div className={`success-message ${showBackupReminder ? 'backup-reminder' : ''}`}>{successMessage}</div>}

                    {showBackupReminder && (
                        <BackupReminderModal
                            onExport={() => { exportData(); dismissBackupReminder(); }}
                            onDismiss={dismissBackupReminder}
                        />
                    )}

                    {showSettings && (
                        <SettingsModal
                            onClose={() => setShowSettings(false)}
                            onExport={exportData}
                            onImport={importData}
                            onReset={resetData}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                            updateExerciseName={updateExerciseName}
                            moveExercise={moveExercise}
                        />
                    )}

                    {showDayBreakdown && (
                        <DayBreakdownModal
                            onClose={() => setShowDayBreakdown(false)}
                            workoutHistory={workoutHistory}
                            currentDay={currentDay}
                            getCurrentExercises={getCurrentExercises}
                            getPreviousWorkout={getPreviousWorkout}
                        />
                    )}

                    {showEditWorkout && editingWorkout && (
                        <EditWorkoutModal
                            workout={editingWorkout}
                            onClose={() => {
                                setShowEditWorkout(false);
                                setEditingWorkout(null);
                            }}
                            onSave={updateWorkout}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                        />
                    )}

                    <div className="header">
                        <div className="header-top">
                            <h1>Gym Tracker</h1>
                            <button className="settings-btn" onClick={() => setShowSettings(true)}></button>
                        </div>
                        <div className="week-indicator">Week {currentWeek}</div>
                        <div className="nav">
                            <button
                                className={`nav-btn ${currentView === 'workout' ? 'active' : ''}`}
                                onClick={() => setCurrentView('workout')}
                            >
                                Workout
                            </button>
                            <button
                                className={`nav-btn ${currentView === 'weekly' ? 'active' : ''}`}
                                onClick={() => { setCurrentView('weekly'); setViewingWeek(currentWeek); window.scrollTo(0, 0); }}
                            >
                                Weekly
                            </button>
                            <button
                                className={`nav-btn ${currentView === 'progress' ? 'active' : ''}`}
                                onClick={() => setCurrentView('progress')}
                            >
                                Progress
                            </button>
                        </div>
                    </div>

                    <div className="content">
                        {currentView === 'workout' && <WorkoutView
                            currentDay={currentDay}
                            setCurrentDay={setCurrentDay}
                            workoutData={workoutData}
                            loggedExercises={loggedExercises}
                            handleInputChange={handleInputChange}
                            getPreviousWorkout={getPreviousWorkout}
                            logExercise={logExercise}
                            completeDay={completeDay}
                            markDayAsNA={markDayAsNA}
                            getCurrentExercises={getCurrentExercises}
                            currentWeek={currentWeek}
                            workoutHistory={workoutHistory}
                        />}
                        {currentView === 'weekly' && <WeeklyView
                            workoutHistory={workoutHistory}
                            viewingWeek={viewingWeek}
                            setViewingWeek={setViewingWeek}
                            currentWeek={currentWeek}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                            onEditWorkout={(workout) => {
                                setEditingWorkout(workout);
                                setShowEditWorkout(true);
                            }}
                        />}
                        {currentView === 'progress' && <ProgressView
                            workoutHistory={workoutHistory}
                            selectedExercise={selectedExercise}
                            setSelectedExercise={setSelectedExercise}
                            day1Exercises={day1Exercises}
                            day2Exercises={day2Exercises}
                        />}
                    </div>
                </div>
            );
        }

        function BackupReminderModal({ onExport, onDismiss }) {
            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <div className="modal-title"> Backup Reminder</div>
                        <p style={{ color: '#888', marginBottom: '20px', fontSize: '14px' }}>
                            It's been a month! Back up your workout data to keep it safe.
                        </p>
                        <button className="modal-btn primary" onClick={onExport}>
                            Download Backup
                        </button>
                        <button className="modal-btn" onClick={onDismiss}>
                            Remind Me Later
                        </button>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose, onExport, onImport, onReset, day1Exercises, day2Exercises, updateExerciseName, moveExercise }) {
            const fileInputRef = useRef();
            const [settingsView, setSettingsView] = useState('main'); // 'main', 'exercises-day1', 'exercises-day2'
            const [editingExercise, setEditingExercise] = useState(null);
            const [tempName, setTempName] = useState('');

            const handleStartEdit = (exercise) => {
                setEditingExercise(exercise.id);
                setTempName(exercise.name);
            };

            const handleSaveEdit = (day, exerciseId) => {
                if (tempName.trim()) {
                    updateExerciseName(day, exerciseId, tempName.trim());
                }
                setEditingExercise(null);
                setTempName('');
            };

            const handleCancelEdit = () => {
                setEditingExercise(null);
                setTempName('');
            };

            if (settingsView === 'exercises-day1' || settingsView === 'exercises-day2') {
                const day = settingsView === 'exercises-day1' ? 1 : 2;
                const exercises = day === 1 ? day1Exercises : day2Exercises;
                const dayName = day === 1 ? 'Full Body' : 'Accessory';

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px', maxHeight: '80vh', overflowY: 'auto' }}>
                            <div className="modal-title">{dayName} Day Exercises</div>

                            <div style={{ marginBottom: '20px' }}>
                                {exercises.map((exercise, idx) => (
                                    <div key={exercise.id} style={{
                                        background: '#1a1a2a',
                                        borderRadius: '8px',
                                        padding: '12px',
                                        marginBottom: '8px',
                                        border: '1px solid #2a2a3a'
                                    }}>
                                        {editingExercise === exercise.id ? (
                                            <div>
                                                <input
                                                    type="text"
                                                    value={tempName}
                                                    onChange={(e) => setTempName(e.target.value)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '8px',
                                                        background: '#0d0d1a',
                                                        border: '1px solid #3a2a5a',
                                                        borderRadius: '4px',
                                                        color: '#b8b8d0',
                                                        marginBottom: '8px'
                                                    }}
                                                    autoFocus
                                                />
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => handleSaveEdit(day, exercise.id)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '6px',
                                                            background: '#3a2a5a',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            color: '#b8b8d0',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Save
                                                    </button>
                                                    <button
                                                        onClick={handleCancelEdit}
                                                        style={{
                                                            flex: 1,
                                                            padding: '6px',
                                                            background: '#1a1a2a',
                                                            border: '1px solid #2a2a3a',
                                                            borderRadius: '4px',
                                                            color: '#8a8aa0',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <div style={{ flex: 1, fontWeight: '600' }}>
                                                    {exercise.name}
                                                </div>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'up')}
                                                    disabled={idx === 0}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === 0 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === 0 ? '#555' : '#8a8aa0',
                                                        cursor: idx === 0 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    
                                                    </button>
                                                <button
                                                    onClick={() => moveExercise(day, exercise.id, 'down')}
                                                    disabled={idx === exercises.length - 1}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: idx === exercises.length - 1 ? '#0d0d1a' : '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: idx === exercises.length - 1 ? '#555' : '#8a8aa0',
                                                        cursor: idx === exercises.length - 1 ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    
                                                </button>
                                                <button
                                                    onClick={() => handleStartEdit(exercise)}
                                                    style={{
                                                        padding: '4px 8px',
                                                        background: '#1a1a2a',
                                                        border: '1px solid #2a2a3a',
                                                        borderRadius: '4px',
                                                        color: '#8a8aa0',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <button className="modal-btn" onClick={() => setSettingsView('main')}>
                                 Back to Settings
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-title">Settings</div>

                        <button className="modal-btn" onClick={() => setSettingsView('exercises-day1')}>
                             Manage Full Body Day Exercises
                        </button>
                        <button className="modal-btn" onClick={() => setSettingsView('exercises-day2')}>
                             Manage Accessory Day Exercises
                        </button>

                        <div style={{ height: '1px', background: '#2a2a3a', margin: '12px 0' }}></div>

                        <button className="modal-btn" onClick={onExport}>
                             Export Data
                        </button>
                        <button className="modal-btn" onClick={() => fileInputRef.current.click()}>
                             Import Data
                        </button>
                        <button className="modal-btn danger" onClick={onReset}>
                             Reset All Data
                        </button>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept=".json"
                            className="file-input"
                            onChange={onImport}
                        />
                        <button className="modal-btn" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function EditWorkoutModal({ workout, onClose, onSave, day1Exercises, day2Exercises }) {
            const [editedExercises, setEditedExercises] = useState(workout.exercises);
            const allExercises = workout.day === 1 ? day1Exercises : day2Exercises;

            const handleExerciseChange = (exerciseId, field, value) => {
                setEditedExercises(prev => {
                    const updated = [...prev];
                    const exerciseIndex = updated.findIndex(e => e.id === exerciseId);
                    if (exerciseIndex !== -1) {
                        updated[exerciseIndex] = {
                            ...updated[exerciseIndex],
                            [field]: value
                        };
                    }
                    return updated;
                });
            };

            const handleSave = () => {
                onSave(workout.date, editedExercises);
                onClose();
            };

            const date = new Date(workout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const dayName = workout.day === 1 ? 'Full Body' : 'Accessory';

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px', maxHeight: '80vh', overflowY: 'auto' }}>
                        <div className="modal-title">Edit Workout - {dayName} Day</div>
                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        {allExercises.map((exercise) => {
                            const editedExercise = editedExercises.find(e => e.id === exercise.id);

                            return (
                                <div key={exercise.id} style={{
                                    background: '#1a1a2a',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    marginBottom: '12px',
                                    border: '1px solid #2a2a3a'
                                }}>
                                    <div style={{ fontWeight: '600', marginBottom: '8px' }}>
                                        {exercise.name}
                                    </div>
                                    {exercise.type === 'assault-bike' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="30/30"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Rounds"
                                                value={editedExercise?.rounds || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'rounds', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : exercise.type === 'stairmaster' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <select
                                                value={editedExercise?.level || 'Level 7'}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'level', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            >
                                                <option value="Level 7">Level 7</option>
                                                <option value="Level 8">Level 8</option>
                                                <option value="Level 9">Level 9</option>
                                                <option value="Level 10">Level 10</option>
                                            </select>
                                            <select
                                                value={editedExercise?.time || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'time', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            >
                                                <option value="">Select time</option>
                                                {(() => {
                                                    const timeOptions = [];
                                                    for (let minutes = 5; minutes <= 20; minutes++) {
                                                        for (let seconds = 0; seconds < 60; seconds += 15) {
                                                            if (minutes === 20 && seconds > 0) break;
                                                            const time = formatSecondsToTime(minutes * 60 + seconds);
                                                            timeOptions.push(<option key={time} value={time}>{time}</option>);
                                                        }
                                                    }
                                                    return timeOptions;
                                                })()}
                                            </select>
                                        </div>
                                    ) : exercise.type === 'bodyweight' ? (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value="Body Weight"
                                                disabled
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #2a2a3a',
                                                    borderRadius: '4px',
                                                    color: '#666'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="number"
                                                placeholder="Weight"
                                                value={editedExercise?.weight || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'weight', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                            <input
                                                type="number"
                                                placeholder="Reps"
                                                value={editedExercise?.reps || ''}
                                                onChange={(e) => handleExerciseChange(exercise.id, 'reps', e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '8px',
                                                    background: '#0d0d1a',
                                                    border: '1px solid #3a2a5a',
                                                    borderRadius: '4px',
                                                    color: '#b8b8d0'
                                                }}
                                            />
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <div style={{ display: 'flex', gap: '8px', marginTop: '20px' }}>
                            <button className="modal-btn primary" onClick={handleSave} style={{ flex: 1 }}>
                                Save Changes
                            </button>
                            <button className="modal-btn" onClick={onClose} style={{ flex: 1 }}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function DayBreakdownModal({ onClose, workoutHistory, currentDay, getCurrentExercises, getPreviousWorkout }) {
            // Find today's workout
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayWorkout = workoutHistory.find(w => {
                const workoutDate = new Date(w.date);
                workoutDate.setHours(0, 0, 0, 0);
                const isSameDay = workoutDate.getTime() === today.getTime();
                const isSameWorkoutDay = w.day === currentDay;
                return isSameDay && isSameWorkoutDay;
            });

            if (!todayWorkout) {
                return null;
            }

            // Function to get most recent previous workout for the same exercise
            const getPreviousWorkoutForExercise = (exerciseId) => {
                const todayDate = new Date(todayWorkout.date);

                console.log('Looking for previous workout for:', exerciseId, 'Current day type:', currentDay);

                // Find most recent workout of the same day type (before today)
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        return w.day === currentDay && workoutDate < todayDate;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                console.log('Previous workout found:', previousWorkout ? 'Yes' : 'No');

                if (!previousWorkout) return null;

                const exercise = previousWorkout.exercises.find(e => e.id === exerciseId);
                return exercise;
            };

            // Get only exercises that match the current day
            const currentDayExerciseIds = new Set(getCurrentExercises().map(e => e.id));
            const currentDayWorkoutExercises = todayWorkout.exercises.filter(e => currentDayExerciseIds.has(e.id));

            // Calculate PRs (just count them)
            let prCount = 0;
            currentDayWorkoutExercises.forEach(exercise => {
                if (!exercise.weight && !exercise.reps && !exercise.rounds && !exercise.time) {
                    return; // Skip NA exercises
                }

                const previous = getPreviousWorkoutForExercise(exercise.id);
                if (!previous) {
                    console.log('No previous data for:', exercise.name);
                    return; // Skip if no previous workout
                }

                let isPR = false;

                if (exercise.type === 'assault-bike') {
                    if (parseInt(exercise.rounds) > parseInt(previous.rounds || 0)) {
                        isPR = true;
                    }
                } else if (exercise.type === 'stairmaster') {
                    const currentSeconds = parseTimeToSeconds(exercise.time);
                    const previousSeconds = parseTimeToSeconds(previous.time);
                    if (currentSeconds > previousSeconds) {
                        isPR = true;
                    }
                } else if (exercise.type === 'bodyweight') {
                    const currentReps = parseInt(exercise.reps);
                    const previousReps = parseInt(previous.reps || 0);
                    console.log('Bodyweight comparison:', exercise.name, 'Current:', currentReps, 'Previous:', previousReps);
                    if (currentReps > previousReps && currentReps >= 6) {
                        isPR = true;
                    }
                } else {
                    // Standard exercise - PR if weight OR reps increased (and reps >= 6)
                    const currentWeight = parseFloat(exercise.weight);
                    const previousWeight = parseFloat(previous.weight);
                    const currentReps = parseInt(exercise.reps);
                    const previousReps = parseInt(previous.reps);

                    console.log('Standard comparison:', exercise.name, 'Current:', currentWeight, 'lbs x', currentReps, 'Previous:', previousWeight, 'lbs x', previousReps);

                    if ((currentWeight > previousWeight || currentReps > previousReps) && currentReps >= 6) {
                        isPR = true;
                    }
                }

                if (isPR) {
                    console.log('PR detected for:', exercise.name);
                    prCount++;
                }
            });

            console.log('Total PR count:', prCount);

            // Count completed exercises (only for current day, excluding NA)
            const completedCount = currentDayWorkoutExercises.filter(e => {
                // Check if exercise has valid data (not NA)
                if (e.type === 'assault-bike') {
                    return e.rounds && e.rounds !== 'NA';
                } else if (e.type === 'stairmaster') {
                    return e.time && e.time !== 'NA';
                } else if (e.type === 'bodyweight') {
                    return e.reps && e.reps !== 'NA';
                } else {
                    return (e.weight && e.weight !== 'NA') || (e.reps && e.reps !== 'NA');
                }
            }).length;
            const totalCount = getCurrentExercises().length;

            const date = new Date(todayWorkout.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                        <div className="modal-title">{currentDay === 1 ? 'Full Body' : 'Accessory'} Day Breakdown</div>

                        <div style={{ marginBottom: '20px', color: '#888', fontSize: '14px' }}>
                            {formattedDate}
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '10px' }}>
                                Exercises Completed
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: '#3a2a5a' }}>
                                {completedCount} / {totalCount}
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '10px' }}>
                                PRs Smashed
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: '#3a2a5a' }}>
                                {prCount}
                            </div>
                        </div>

                        <button className="modal-btn primary" onClick={onClose}>
                            Close
                        </button>
                    </div>
                </div>
            );
        }

        function WorkoutView({ currentDay, setCurrentDay, workoutData, loggedExercises, handleInputChange, getPreviousWorkout, logExercise, completeDay, markDayAsNA, getCurrentExercises, currentWeek, userBodyweight, workoutHistory }) {
            const exercises = getCurrentExercises();
            const upperExercises = exercises.filter(e => e.category === 'Upper');
            const lowerExercises = exercises.filter(e => e.category === 'Lower');
            const accessoryExercises = exercises.filter(e => e.category === 'Accessories');
            const cardioExercises = exercises.filter(e => e.category === 'Cardio');
            const todayDay = getTodayDay();

            // Helper function to check if an exercise has valid data (not NA)
            const isValidExercise = (exercise) => {
                if (!exercise) return false;
                if (exercise.reps === 'NA' || exercise.weight === 'NA') return false;
                if (!exercise.reps || !exercise.weight) return false;
                return true;
            };

            // Helper function to check if exercise is marked for plateau busting
            const isPlateauBuster = (exerciseId) => {
                if (!workoutHistory || workoutHistory.length === 0) return false;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout of the same day type with valid data for this exercise
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                if (!previousWorkout || !previousWorkout.plateauBusters) return false;

                return previousWorkout.plateauBusters.includes(exerciseId);
            };

            // Helper function to check if this is a PR Weight Recovery week (week after plateau buster)
            const getPRWeightRecovery = (exerciseId) => {
                if (!workoutHistory || workoutHistory.length < 2) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get the two most recent previous workouts of the same day type with valid data
                const previousWorkouts = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (previousWorkouts.length < 2) return null;

                const twoWeeksAgo = previousWorkouts[1];

                // Check if two weeks ago had this exercise as a plateau buster
                // That means last week the user saw the gold plateau buster reminder
                // This week they should see green and recover to the original weight
                if (twoWeeksAgo.plateauBusters && twoWeeksAgo.plateauBusters.includes(exerciseId)) {
                    const twoWeeksExercise = twoWeeksAgo.exercises.find(e => e.id === exerciseId);
                    if (twoWeeksExercise && twoWeeksExercise.weight) {
                        return {
                            weight: twoWeeksExercise.weight,
                            reps: '6'  // Always show 6 as the target for Trial of Strength
                        };
                    }
                }

                return null;
            };

            // Helper function to check if this is a PR Auto-Regulation week (after hitting 8+ reps)
            const getPRAutoRegulation = (exerciseId) => {
                console.log('[getPRAutoRegulation] Checking for:', exerciseId);
                if (!workoutHistory || workoutHistory.length === 0) {
                    console.log('[getPRAutoRegulation] No workout history');
                    return null;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout with valid data
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                console.log('[getPRAutoRegulation] Previous workout:', previousWorkout);

                if (!previousWorkout) {
                    console.log('[getPRAutoRegulation] No previous workout found');
                    return null;
                }

                const previousExercise = previousWorkout.exercises.find(e => e.id === exerciseId);
                console.log('[getPRAutoRegulation] Previous exercise:', previousExercise);

                // Check if last week hit a PR (8+ reps) and has a weight increment defined
                if (previousExercise && previousExercise.reps && parseInt(previousExercise.reps) >= 8 &&
                    previousExercise.weight && PR_WEIGHT_INCREMENTS[exerciseId]) {
                    const lastWeight = parseFloat(previousExercise.weight);
                    const increment = PR_WEIGHT_INCREMENTS[exerciseId];
                    const newWeight = (lastWeight + increment).toString();

                    console.log('[getPRAutoRegulation] PR DETECTED! Last:', lastWeight, 'lbs x', previousExercise.reps, 'New:', newWeight);

                    return {
                        weight: newWeight,
                        lastWeight: previousExercise.weight,
                        lastReps: previousExercise.reps,
                        increment: increment
                    };
                }

                console.log('[getPRAutoRegulation] No PR (reps < 8 or missing data)');
                return null;
            };

            // Helper function for plateau buster weight decrement
            const getPlateauBusterDecrement = (exerciseId) => {
                console.log('[getPlateauBusterDecrement] Checking for:', exerciseId);
                if (!workoutHistory || workoutHistory.length === 0) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find most recent previous workout with valid data
                const previousWorkout = workoutHistory
                    .filter(w => {
                        const workoutDate = new Date(w.date);
                        workoutDate.setHours(0, 0, 0, 0);
                        if (w.day !== currentDay) return false;
                        // Exclude future workouts
                        if (workoutDate > today) return false;

                        // Exclude today's unsubmitted workout
                        if (workoutDate.getTime() === today.getTime() && !w.submitted) return false;

                        // Check if this workout has valid data for this exercise
                        const exercise = w.exercises.find(e => e.id === exerciseId);
                        return isValidExercise(exercise);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                console.log('[getPlateauBusterDecrement] Previous workout:', previousWorkout);
                console.log('[getPlateauBusterDecrement] Plateau busters:', previousWorkout?.plateauBusters);

                if (!previousWorkout || !previousWorkout.plateauBusters || !previousWorkout.plateauBusters.includes(exerciseId)) {
                    console.log('[getPlateauBusterDecrement] Not a plateau buster');
                    return null;
                }

                const previousExercise = previousWorkout.exercises.find(e => e.id === exerciseId);

                // Decrease weight by the increment amount
                if (previousExercise && previousExercise.weight && PR_WEIGHT_INCREMENTS[exerciseId]) {
                    const lastWeight = parseFloat(previousExercise.weight);
                    const increment = PR_WEIGHT_INCREMENTS[exerciseId];
                    const newWeight = (lastWeight - increment).toString();

                    console.log('[getPlateauBusterDecrement] PLATEAU BUSTER! Last:', lastWeight, 'New:', newWeight);

                    return {
                        weight: newWeight,
                        lastWeight: previousExercise.weight,
                        increment: increment
                    };
                }

                console.log('[getPlateauBusterDecrement] Missing data');
                return null;
            };

            const renderExercise = (exercise) => {
                const previous = getPreviousWorkout(exercise.id);
                const isLogged = loggedExercises[exercise.id];
                const data = workoutData[exercise.id] || {};
                const showPlateauBuster = isPlateauBuster(exercise.id);
                const prWeightRecovery = getPRWeightRecovery(exercise.id);
                const prAutoRegulation = !prWeightRecovery ? getPRAutoRegulation(exercise.id) : null; // Only show if not already showing plateau recovery
                const plateauBusterDecrement = showPlateauBuster && !prWeightRecovery ? getPlateauBusterDecrement(exercise.id) : null;

                if (exercise.type === 'standard') {
                    console.log('[renderExercise]', exercise.name, {
                        showPlateauBuster,
                        prWeightRecovery,
                        prAutoRegulation,
                        plateauBusterDecrement,
                        previous
                    });
                }

                // Get default weight for Week 1
                const defaultWeight = currentWeek === 1 && !previous ? WEEK_1_DEFAULTS[exercise.id] : null;

                if (exercise.type === 'assault-bike') {
                    // Generate round options from 5 to 20
                    const roundOptions = [];
                    for (let i = 5; i <= 20; i++) {
                        roundOptions.push(i);
                    }

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div>
                                    <div className="exercise-name">
                                        {exercise.name}
                                    </div>
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.rounds} rounds
                                    </div>
                                )}
                            </div>
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Intensity</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="30/30"
                                        disabled
                                    />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Rounds</label>
                                    <select
                                        className="input-field"
                                        value={data.rounds || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'rounds', e.target.value)}
                                        disabled={isLogged}
                                    >
                                        <option value="">{previous?.rounds ? `${previous.rounds} rounds` : 'Select rounds'}</option>
                                        {roundOptions.map(rounds => (
                                            <option key={rounds} value={rounds}>{rounds}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                if (exercise.type === 'stairmaster') {
                    // Generate time options from 5:00 to 20:00 in 15-second increments
                    const timeOptions = [];
                    for (let minutes = 5; minutes <= 20; minutes++) {
                        for (let seconds = 0; seconds < 60; seconds += 15) {
                            if (minutes === 20 && seconds > 0) break; // Stop at 20:00
                            timeOptions.push(formatSecondsToTime(minutes * 60 + seconds));
                        }
                    }

                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div className="exercise-name">
                                    {exercise.name}
                                </div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.level || 'Level 7'} - {previous.time}
                                    </div>
                                )}
                            </div>
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Level</label>
                                    <select
                                        className="input-field"
                                        value={data.level || previous?.level || 'Level 7'}
                                        onChange={(e) => handleInputChange(exercise.id, 'level', e.target.value)}
                                        disabled={isLogged}
                                    >
                                        <option value="Level 7">Level 7</option>
                                        <option value="Level 8">Level 8</option>
                                        <option value="Level 9">Level 9</option>
                                        <option value="Level 10">Level 10</option>
                                    </select>
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Time</label>
                                    <select
                                        className="input-field"
                                        value={data.time || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'time', e.target.value)}
                                        disabled={isLogged}
                                    >
                                        <option value="">{previous?.time || 'Select time'}</option>
                                        {timeOptions.map(time => (
                                            <option key={time} value={time}>{time}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                if (exercise.type === 'bodyweight') {
                    return (
                        <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                            <div className="exercise-header">
                                <div className="exercise-name">{exercise.name}</div>
                                {previous && (
                                    <div className="previous-data">
                                        Last: {previous.reps} reps
                                    </div>
                                )}
                            </div>
                            {prWeightRecovery ? (
                                <div style={{
                                    color: '#4CAF50',
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    marginBottom: '12px',
                                    fontWeight: '600',
                                    fontSize: '14px',
                                    textAlign: 'center'
                                }}>
                                    Trial of Strength
                                </div>
                            ) : showPlateauBuster ? (
                                <div style={{
                                    color: '#ff9500',
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    marginBottom: '12px',
                                    fontWeight: '600',
                                    fontSize: '14px',
                                    textAlign: 'center'
                                }}>
                                    Plateau Buster - Hit 2 sets
                                </div>
                            ) : null}
                            <div className="input-row">
                                <div className="input-group">
                                    <label className="input-label">Weight</label>
                                    <input
                                        type="text"
                                        className="input-field"
                                        value="Body Weight"
                                        disabled
                                    />
                                </div>
                                <div className="input-group" style={{ position: 'relative' }}>
                                    {prWeightRecovery && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '-20px',
                                            left: '0',
                                            color: '#4CAF50',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            PR Reps to Beat
                                        </div>
                                    )}
                                    <label className="input-label">Reps</label>
                                    <input
                                        type="number"
                                        inputMode="numeric"
                                        className="input-field"
                                        value={data.reps || ''}
                                        onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                        placeholder={prWeightRecovery?.reps || previous?.reps || ''}
                                        disabled={isLogged}
                                        style={prWeightRecovery ? {
                                            border: '2px solid #4CAF50'
                                        } : {}}
                                    />
                                </div>
                            </div>
                            <button
                                className={`log-btn ${isLogged ? 'logged' : ''}`}
                                onClick={() => logExercise(exercise.id)}
                                disabled={isLogged}
                            >
                                {isLogged ? ' Logged' : 'LOG'}
                            </button>
                        </div>
                    );
                }

                // Standard exercise
                return (
                    <div key={exercise.id} data-exercise-id={exercise.id} className={`exercise-card ${isLogged ? 'logged' : ''}`}>
                        <div className="exercise-header">
                            <div>
                                <div className="exercise-name">
                                    {exercise.name}
                                </div>
                                {previous && (
                                    <div className="previous-data" style={{ marginTop: '4px' }}>
                                        Last: {previous.weight}lbs  {previous.reps}
                                    </div>
                                )}
                            </div>
                        </div>
                        {prWeightRecovery ? (
                            <div style={{
                                color: '#4CAF50',
                                padding: '8px 12px',
                                borderRadius: '6px',
                                marginBottom: '12px',
                                fontWeight: '600',
                                fontSize: '14px',
                                textAlign: 'center'
                            }}>
                                Trial of Strength
                            </div>
                        ) : showPlateauBuster ? (
                            <div style={{
                                color: '#ff9500',
                                padding: '8px 12px',
                                borderRadius: '6px',
                                marginBottom: '12px',
                                fontWeight: '600',
                                fontSize: '14px',
                                textAlign: 'center'
                            }}>
                                Plateau Buster - Hit 2 sets
                            </div>
                        ) : null}
                        {prWeightRecovery && (
                            <div style={{
                                color: '#4CAF50',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '-4px'
                            }}>
                                PR Weight Detected
                            </div>
                        )}
                        {prAutoRegulation && !prWeightRecovery && (
                            <div style={{
                                color: '#4CAF50',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '4px'
                            }}>
                                +{prAutoRegulation.increment}lbs
                            </div>
                        )}
                        {plateauBusterDecrement && !prWeightRecovery && !prAutoRegulation && (
                            <div style={{
                                color: '#ff9500',
                                fontSize: '12px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                marginTop: '4px'
                            }}>
                                -{plateauBusterDecrement.increment}lbs
                            </div>
                        )}
                        <div className="input-row">
                            <div className="input-group">
                                <label className="input-label">Weight (lbs)</label>
                                <input
                                    type="number"
                                    inputMode="decimal"
                                    className="input-field"
                                    value={data.weight !== undefined ? data.weight : (prWeightRecovery?.weight || prAutoRegulation?.weight || plateauBusterDecrement?.weight || previous?.weight || '')}
                                    onChange={(e) => handleInputChange(exercise.id, 'weight', e.target.value)}
                                    placeholder={previous?.weight || ''}
                                    disabled={isLogged}
                                    style={prWeightRecovery || prAutoRegulation ? {
                                        border: '2px solid #4CAF50'
                                    } : showPlateauBuster ? {
                                        border: '2px solid #ff9500'
                                    } : {}}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Reps</label>
                                <input
                                    type="number"
                                    inputMode="numeric"
                                    className="input-field"
                                    value={data.reps || ''}
                                    onChange={(e) => handleInputChange(exercise.id, 'reps', e.target.value)}
                                    placeholder={prWeightRecovery?.reps || (prAutoRegulation ? '6' : (plateauBusterDecrement ? '8' : (previous?.reps ? String(parseInt(previous.reps) + 1) : '')))}
                                    disabled={isLogged}
                                />
                            </div>
                        </div>
                        <button
                            className={`log-btn ${isLogged ? 'logged' : ''}`}
                            onClick={() => logExercise(exercise.id)}
                            disabled={isLogged}
                        >
                            {isLogged ? ' Logged' : 'LOG'}
                        </button>
                    </div>
                );
            };

            return (
                <>
                    <div className="day-selector">
                        <button
                            className={`day-btn ${currentDay === 1 ? 'active' : ''}`}
                            onClick={() => setCurrentDay(1)}
                        >
                            Full Body Day{todayDay === 1 ? ' (Today)' : ''}
                        </button>
                        <button
                            className={`day-btn ${currentDay === 2 ? 'active' : ''}`}
                            onClick={() => setCurrentDay(2)}
                        >
                            Accessory Day{todayDay === 2 ? ' (Today)' : ''}
                        </button>
                    </div>

                    {currentDay === 1 ? (
                        <>
                            <div className="section-title">Upper Body</div>
                            {upperExercises.map(renderExercise)}

                            <div className="section-title">Lower Body</div>
                            {lowerExercises.map(renderExercise)}
                        </>
                    ) : (
                        <>
                            <div className="section-title">Accessories</div>
                            {accessoryExercises.map(renderExercise)}

                            <div className="section-title">Cardio</div>
                            {cardioExercises.map(renderExercise)}
                        </>
                    )}

                    <button className="save-btn" onClick={completeDay}>
                        Submit Day and View Breakdown
                    </button>

                    <button className="na-btn" onClick={markDayAsNA}>
                        NA
                    </button>
                </>
            );
        }


        function WeeklyView({ workoutHistory, viewingWeek, setViewingWeek, currentWeek, day1Exercises, day2Exercises, onEditWorkout }) {
            const weekWorkouts = workoutHistory
                .filter(w => w.week === viewingWeek)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest to oldest

            return (
                <>
                    <div className="week-nav">
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek - 1)}
                            disabled={viewingWeek <= 1}
                        >
                             Prev
                        </button>
                        <div className="week-title">
                            Week {viewingWeek}
                            {viewingWeek === currentWeek && ' (Current)'}
                        </div>
                        <button
                            className="week-nav-btn"
                            onClick={() => setViewingWeek(viewingWeek + 1)}
                            disabled={viewingWeek >= currentWeek}
                        >
                            Next 
                        </button>
                    </div>

                    {weekWorkouts.length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"></div>
                            <div>No workouts in Week {viewingWeek}</div>
                        </div>
                    ) : (
                        <>
                            {weekWorkouts.map((workout, idx) => {
                                const date = new Date(workout.date);
                                const formattedDate = date.toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                const formattedTime = date.toLocaleTimeString('en-US', {
                                    hour: 'numeric',
                                    minute: '2-digit'
                                });

                                // Get all exercises for this day
                                const allExercises = workout.day === 1 ? day1Exercises : day2Exercises;
                                const completedIds = new Set(workout.exercises.map(e => e.id));

                                // Calculate sequential day number - count down from total
                                const dayNumber = weekWorkouts.length - idx;

                                return (
                                    <div key={idx} className="history-item">
                                        <div className="history-date" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <span>Day {dayNumber} - {formattedDate}</span>
                                            <button
                                                onClick={() => onEditWorkout(workout)}
                                                style={{
                                                    background: 'none',
                                                    border: 'none',
                                                    color: '#6a5a8a',
                                                    cursor: 'pointer',
                                                    fontSize: '18px',
                                                    padding: '4px 8px'
                                                }}
                                            >
                                                
                                            </button>
                                        </div>
                                        {allExercises.map((expectedExercise) => {
                                            const completedExercise = workout.exercises.find(e => e.id === expectedExercise.id);
                                            return (
                                                <div key={expectedExercise.id} className="history-exercise">
                                                    <div className="history-exercise-name">{expectedExercise.name}</div>
                                                    <div className="history-exercise-data">
                                                        {completedExercise ? (
                                                            completedExercise.type === 'assault-bike'
                                                                ? (completedExercise.rounds ? `${completedExercise.rounds} rounds` : <span style={{ color: '#555' }}>NA</span>)
                                                                : completedExercise.type === 'stairmaster'
                                                                ? (completedExercise.time ? `${completedExercise.level || 'Level 7'} - ${completedExercise.time}` : <span style={{ color: '#555' }}>NA</span>)
                                                                : (completedExercise.weight && completedExercise.reps
                                                                    ? `${completedExercise.weight}${completedExercise.weight === 'Body Weight' ? '' : 'lbs'}  ${completedExercise.reps}`
                                                                    : <span style={{ color: '#555' }}>NA</span>)
                                                        ) : (
                                                            <span style={{ color: '#555' }}>NA</span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}
                        </>
                    )}
                </>
            );
        }

        function ProgressView({ workoutHistory, selectedExercise, setSelectedExercise, day1Exercises, day2Exercises }) {
            const allExercises = [...day1Exercises, ...day2Exercises];

            useEffect(() => {
                if (workoutHistory.length === 0) return;

                const ctx = document.getElementById('progressChart');
                if (!ctx) return;

                const exercise = allExercises.find(e => e.id === selectedExercise);
                const exerciseData = workoutHistory
                    .map(w => ({
                        date: new Date(w.date),
                        exercise: w.exercises.find(e => e.id === selectedExercise)
                    }))
                    .filter(d => d.exercise)
                    .reverse();

                if (exercise?.type === 'assault-bike') {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                            datasets: [
                                {
                                    label: 'Rounds',
                                    data: exerciseData.map(d => parseInt(d.exercise.rounds) || 0),
                                    borderColor: '#0a84ff',
                                    backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#fff' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#888'
                                    }
                                },
                                y: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Rounds',
                                        color: '#888'
                                    }
                                }
                            }
                        }
                    });
                    return () => chart.destroy();
                }

                if (exercise?.type === 'stairmaster') {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                            datasets: [
                                {
                                    label: 'Time (seconds)',
                                    data: exerciseData.map(d => parseTimeToSeconds(d.exercise.time)),
                                    borderColor: '#0a84ff',
                                    backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#fff' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#888' },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#888'
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#888',
                                        callback: function(value) {
                                            return formatSecondsToTime(value);
                                        }
                                    },
                                    grid: { color: '#2a2a2a' },
                                    title: {
                                        display: true,
                                        text: 'Time',
                                        color: '#888'
                                    }
                                }
                            }
                        }
                    });
                    return () => chart.destroy();
                }

                // Standard exercise - show only weight
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: exerciseData.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [
                            {
                                label: 'Weight (lbs)',
                                data: exerciseData.map(d => {
                                    if (d.exercise.weight === 'Body Weight') return 0;
                                    return parseFloat(d.exercise.weight) || 0;
                                }),
                                borderColor: '#0a84ff',
                                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#888' },
                                grid: { color: '#2a2a2a' },
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#888'
                                }
                            },
                            y: {
                                ticks: { color: '#888' },
                                grid: { color: '#2a2a2a' },
                                title: {
                                    display: true,
                                    text: 'Weight (lbs)',
                                    color: '#888'
                                }
                            }
                        }
                    }
                });

                return () => chart.destroy();
            }, [workoutHistory, selectedExercise]);

            if (workoutHistory.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon"></div>
                        <div>Complete some workouts to see progress</div>
                    </div>
                );
            }

            return (
                <>
                    <select
                        className="exercise-select"
                        value={selectedExercise}
                        onChange={(e) => setSelectedExercise(e.target.value)}
                    >
                        <optgroup label="Full Body - Upper Body">
                            {day1Exercises.filter(e => e.category === 'Upper').map(ex => (
                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                            ))}
                        </optgroup>
                        <optgroup label="Full Body - Lower Body">
                            {day1Exercises.filter(e => e.category === 'Lower').map(ex => (
                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                            ))}
                        </optgroup>
                        <optgroup label="Full Body - Cardio">
                            {day1Exercises.filter(e => e.category === 'Cardio').map(ex => (
                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                            ))}
                        </optgroup>
                        <optgroup label="Accessory - Accessories">
                            {day2Exercises.filter(e => e.category === 'Accessories').map(ex => (
                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                            ))}
                        </optgroup>
                        <optgroup label="Accessory - Cardio">
                            {day2Exercises.filter(e => e.category === 'Cardio').map(ex => (
                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                            ))}
                        </optgroup>
                    </select>
                    <div className="chart-container">
                        <div className="chart-title">
                            {allExercises.find(e => e.id === selectedExercise)?.name}
                        </div>
                        <canvas id="progressChart"></canvas>
                    </div>
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
